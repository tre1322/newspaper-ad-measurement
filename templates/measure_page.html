{% extends "base.html" %}

{% block title %}Page {{ current_page }} - {{ publication.original_filename }}{% endblock %}

{% block content %}
<style>
    .page-viewer {
        position: relative;
        border: 1px solid #ddd;
        background: #f8f9fa;
        max-height: 80vh;
        overflow: auto;
    }
    
    .page-container {
        position: relative;
        display: inline-block;
        margin: 20px;
    }

    .page-image {
        display: block;
        max-width: none;
        user-select: none;
        -webkit-user-drag: none;
    }

    /* Context Menu Styles */
    .context-menu {
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        z-index: 1000;
        min-width: 160px;
        display: none;
    }

    .context-menu-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s;
    }

    .context-menu-item:hover {
        background-color: #f0f0f0;
    }

    /* Broadsheet ad box styles */
    .ad-box {
        border: 2px solid #28a745 !important;
        background: rgba(40, 167, 69, 0.1) !important;
        cursor: move;
        user-select: none;
    }

    .ad-box:hover {
        border-color: #1e7e34 !important;
        background: rgba(40, 167, 69, 0.2) !important;
    }

    .ad-label {
        position: absolute;
        top: 2px;
        left: 2px;
        background: rgba(40, 167, 69, 0.9);
        color: white;
        padding: 2px 6px;
        font-size: 11px;
        border-radius: 3px;
        font-weight: bold;
        pointer-events: none;
    }

    .delete-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
    }

    .delete-btn:hover {
        background: #c82333;
    }

    .context-menu-item:last-child {
        border-bottom: none;
    }

    /* Ad Markers */
    .ad-marker {
        position: absolute;
        width: 30px;
        height: 30px;
        background-color: #007bff;
        color: white;
        border: 2px solid white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
        cursor: pointer;
        z-index: 100;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        transform: translate(-50%, -50%);
    }

    .ad-marker:hover {
        background-color: #0056b3;
        transform: translate(-50%, -50%) scale(1.1);
    }

    /* Manual box specific styles */
    .manual-box {
        border: 2px solid #6f42c1 !important;
        background: rgba(111, 66, 193, 0.1) !important;
    }

    .manual-box:hover {
        border-color: #5a2d7d !important;
        background: rgba(111, 66, 193, 0.2) !important;
    }

    .manual-box .resize-handle {
        background: #6f42c1 !important;
        border: 1px solid white !important;
        opacity: 1 !important;
        z-index: 200;
        width: 10px !important;
        height: 10px !important;
    }

    .manual-box .resize-handle:hover {
        background: #5a2d7d !important;
        transform: scale(1.3) !important;
        box-shadow: 0 0 4px rgba(111, 66, 193, 0.5);
    }

    .manual-box.selected .resize-handle {
        opacity: 1 !important;
        background: #5a2d7d !important;
    }

    .manual-box .delete-handle {
        background: #6f42c1 !important;
        border: 2px solid white !important;
    }

    .manual-box .delete-handle:hover {
        background: #5a2d7d !important;
    }

    .measurements-panel {
        position: sticky;
        top: 20px;
        max-height: 70vh;
        overflow-y: auto;
    }
    
    .ad-item {
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 8px;
        background: #f8f9fa;
        transition: all 0.2s;
    }

    .measurements-updated {
        animation: pulse 0.5s ease-in-out;
    }

    @keyframes pulse {
        0% { background-color: #d4edda; }
        100% { background-color: transparent; }
    }

    /* Special styles for special edition */
    .special-edition .page-viewer {
        cursor: context-menu;
    }

    /* Measurement Box Styles */
    .measurement-box {
        position: absolute;
        border: 2px solid #007bff;
        background: rgba(0, 123, 255, 0.1);
        cursor: move;
        min-width: 20px;
        min-height: 20px;
        box-sizing: border-box;
    }

    .measurement-box:hover {
        border-color: #0056b3;
        background: rgba(0, 123, 255, 0.2);
    }

    .measurement-box.selected {
        border-color: #28a745;
        background: rgba(40, 167, 69, 0.1);
    }

    /* Resize handles */
    .resize-handle {
        position: absolute;
        background: #007bff;
        border: 1px solid white;
        width: 8px;
        height: 8px;
        box-sizing: border-box;
    }

    .resize-handle:hover {
        background: #0056b3;
    }

    .resize-handle.nw {
        top: -4px;
        left: -4px;
        cursor: nw-resize;
    }

    .resize-handle.ne {
        top: -4px;
        right: -4px;
        cursor: ne-resize;
    }

    .resize-handle.sw {
        bottom: -4px;
        left: -4px;
        cursor: sw-resize;
    }

    .resize-handle.se {
        bottom: -4px;
        right: -4px;
        cursor: se-resize;
    }

    .resize-handle.n {
        top: -4px;
        left: 50%;
        transform: translateX(-50%);
        cursor: n-resize;
    }

    .resize-handle.s {
        bottom: -4px;
        left: 50%;
        transform: translateX(-50%);
        cursor: s-resize;
    }

    .resize-handle.w {
        top: 50%;
        left: -4px;
        transform: translateY(-50%);
        cursor: w-resize;
    }

    .resize-handle.e {
        top: 50%;
        right: -4px;
        transform: translateY(-50%);
        cursor: e-resize;
    }

    /* Delete handle */
    .delete-handle {
        position: absolute;
        top: -10px;
        right: -10px;
        width: 20px;
        height: 20px;
        background: #dc3545;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        border: 2px solid white;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .measurement-box:hover .delete-handle {
        opacity: 1;
    }

    .delete-handle:hover {
        background: #c82333;
        transform: scale(1.1);
    }

    /* Regular broadsheet cursor */
    .page-viewer:not(.special-edition) {
        cursor: default;
    }

    /* Full-page ad specific styles */
    .full-page-ad {
        pointer-events: none; /* Prevent dragging */
    }

    .full-page-ad .delete-btn {
        pointer-events: all; /* Allow delete button to be clicked */
    }

    .full-page-label {
        pointer-events: none;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }

    .full-page-item {
        margin-bottom: 10px;
    }

    /* Button styling */
    #fullPageAdBtn {
        font-weight: 600;
        text-shadow: none;
    }

    #fullPageAdBtn:hover {
        background-color: #e0a800;
        border-color: #d39e00;
    }

    /* Enhanced toolbar spacing */
    .d-flex.gap-3 {
        gap: 1rem !important;
    }
</style>

<div class="row">
    <div class="col-12">
        <!-- Navigation Header -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="{{ url_for('measure_publication', pub_id=publication.id) }}">{{ publication.original_filename }}</a>
                        </li>
                        <li class="breadcrumb-item active">Page {{ current_page }}</li>
                    </ol>
                </nav>
            </div>
            
            <div class="d-flex gap-3 align-items-center">
                <!-- Quick Actions -->
                <div class="btn-group" role="group">
                    {% if publication.publication_type == 'broadsheet' %}
                    <button type="button" class="btn btn-warning" id="fullPageAdBtn" title="Add Full-page Ad (258 inches)">
                        <i class="fas fa-newspaper"></i> Full-page Ad
                    </button>
                    <button type="button" class="btn btn-info" id="copyAdBtn" title="Copy last measured ad box" disabled>
                        <i class="fas fa-copy"></i> Copy Ad Measurement
                    </button>
                    <button type="button" class="btn btn-primary" id="matchTemplatesBtn" title="Find ads matching saved templates">
                        <i class="fas fa-search"></i> Match Templates
                    </button>
                    {% endif %}
                    <a href="{{ url_for('publication_report', pub_id=publication.id) }}" class="btn btn-success" title="Generate comprehensive report">
                        <i class="fas fa-chart-bar"></i> Generate Report
                    </a>
                </div>
                
                <!-- Zoom Controls -->
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary" id="zoomOutBtn" title="Zoom Out">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="zoomResetBtn" title="Reset to 100%">
                        <span id="zoomLevel">100%</span>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="zoomInBtn" title="Zoom In">
                        <i class="fas fa-search-plus"></i>
                    </button>
                    <button type="button" class="btn btn-outline-info" id="fitToScreenBtn" title="Fit to Screen">
                        <i class="fas fa-expand-arrows-alt"></i>
                    </button>
                </div>
                
                <!-- Page Navigation -->
                <div class="btn-group" role="group">
                    {% if current_page > 1 %}
                        <a href="{{ url_for('measure_page', pub_id=publication.id, page_num=current_page-1) }}" 
                           class="btn btn-outline-primary">
                            <i class="fas fa-chevron-left"></i> Previous
                        </a>
                    {% endif %}
                    
                    <button type="button" class="btn btn-outline-primary" disabled>
                        {{ current_page }} / {{ total_pages }}
                    </button>
                    
                    {% if current_page < total_pages %}
                        <a href="{{ url_for('measure_page', pub_id=publication.id, page_num=current_page+1) }}" 
                           class="btn btn-outline-primary">
                            Next <i class="fas fa-chevron-right"></i>
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Instructions -->
        {% if publication.publication_type == 'special_edition' %}
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <i class="fas fa-info-circle"></i> 
            <strong>Special Edition Instructions:</strong> 
            Right-click on any advertisement to select its size (1/8, 1/4, 1/2, or Full page) • Click numbered markers to delete ads • Use ← → keys to navigate pages
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% elif publication.publication_type == 'broadsheet' %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-magic"></i> 
            <strong>Intelligent Detection:</strong> 
            <strong>Left-click</strong> on ads for automatic detection • <strong>Right-click</strong> on empty space to create manual box • <strong>Drag purple corner handles</strong> to resize manual boxes • <strong>Full-page Ad</strong> button for complete page coverage • Use ← → keys to navigate pages
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% else %}
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <i class="fas fa-info-circle"></i> 
            <strong>Instructions:</strong> 
            Click "Draw New Box" then drag to create boxes • Drag boxes to move • Drag corners/edges to resize • Click X to delete • Use ← → keys to navigate pages
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}
        
        <!-- Page Viewer and Controls -->
        <div class="row">
            <div class="col-8">
                <div class="page-viewer {{ 'special-edition' if publication.publication_type == 'special_edition' else '' }}" id="pageViewer">
                    <div class="page-container" id="pageContainer">
                        <img src="{{ url_for('serve_page_image', page_id=page.id) }}" 
                             alt="Page {{ current_page }}" 
                             id="pageImage" 
                             class="page-image">
                        
                        {% if publication.publication_type == 'broadsheet' %}
                        <!-- Broadsheet ad boxes with intelligent detection -->
                        {% for box in ad_boxes %}
                        <div class="ad-box" 
                             data-box-id="{{ box.id }}"
                             style="position: absolute; left: {{ box.x }}px; top: {{ box.y }}px; width: {{ box.width }}px; height: {{ box.height }}px; border: 2px solid #28a745; background: rgba(40, 167, 69, 0.1); cursor: move;">
                            
                            <div class="ad-label">{{ "%.1f"|format(box.column_inches) }}" {% if box.ad_type and box.ad_type != 'manual' %}({{ box.ad_type.replace('_', ' ') }}){% endif %}</div>
                            <button class="delete-btn" onclick="deleteAdBox({{ box.id }})" style="position: absolute; top: -5px; right: -5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;">×</button>
                        </div>
                        {% endfor %}
                        {% elif publication.publication_type != 'special_edition' %}
                        <!-- Regular measurement boxes for non-special editions -->
                        {% for box in ad_boxes %}
                        <div class="measurement-box" 
                             data-box-id="{{ box.id }}"
                             style="left: {{ box.x }}px; top: {{ box.y }}px; width: {{ box.width }}px; height: {{ box.height }}px;">
                            
                            <!-- Resize handles -->
                            <div class="resize-handle nw"></div>
                            <div class="resize-handle ne"></div>
                            <div class="resize-handle sw"></div>
                            <div class="resize-handle se"></div>
                            <div class="resize-handle n"></div>
                            <div class="resize-handle s"></div>
                            <div class="resize-handle w"></div>
                            <div class="resize-handle e"></div>
                            
                            <!-- Delete button -->
                            <div class="delete-handle" title="Delete this box">×</div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <!-- Special edition markers -->
                        {% for box in ad_boxes %}
                        <div class="ad-marker" 
                             data-box-id="{{ box.id }}"
                             style="left: {{ box.x + (box.width / 2) }}px; top: {{ box.y + (box.height / 2) }}px;"
                             title="Click to delete">
                            {{ loop.index }}
                        </div>
                        {% endfor %}
                        {% endif %}
                    </div>
                </div>
                
                <!-- Context Menu for Special Edition -->
                {% if publication.publication_type == 'special_edition' %}
                <div class="context-menu" id="contextMenu">
                    <div class="context-menu-item" data-ad-type="eighth" data-inches="14.04">
                        1/8 Page Ad (14.04 inches)
                    </div>
                    <div class="context-menu-item" data-ad-type="quarter" data-inches="28.88">
                        1/4 Page Ad (28.88 inches)
                    </div>
                    <div class="context-menu-item" data-ad-type="half" data-inches="59.28">
                        1/2 Page Ad (59.28 inches)
                    </div>
                    <div class="context-menu-item" data-ad-type="full" data-inches="120.24">
                        Full Page Ad (120.24 inches)
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Measurements Panel -->
            <div class="col-4">
                <div class="measurements-panel">
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-ruler"></i> Page {{ current_page }} Measurements</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3 p-2 bg-light rounded">
                                <strong>Total: <span id="pageTotalInches">{{ "%.0f"|format(page.page_ad_inches) }}</span> column inches</strong>
                                <br>
                                <small class="text-muted">{{ ad_boxes|length }} ads measured</small>
                            </div>
                            
                            {% if publication.publication_type != 'special_edition' and publication.publication_type != 'broadsheet' %}
                            <div class="d-grid mb-3">
                                <button class="btn btn-success" id="addBoxBtn">
                                    <i class="fas fa-plus"></i> Draw New Box
                                </button>
                            </div>
                            {% elif publication.publication_type == 'broadsheet' %}
                            <div class="alert alert-light text-center mb-3">
                                <i class="fas fa-mouse-pointer"></i>
                                <strong>Smart Detection Active</strong><br>
                                <small><strong>Left-click:</strong> Auto-detect ads<br><strong>Right-click:</strong> Place manual box<br><strong>Full-page button:</strong> Complete coverage</small>
                            </div>
                            {% endif %}
                            
                            <hr>
                            
                            <h6>Advertisement List</h6>
                            <div id="adBoxesList" style="max-height: 400px; overflow-y: auto;">
                                {% for box in ad_boxes %}
                                <div class="ad-item" data-box-id="{{ box.id }}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            {% if publication.publication_type == 'special_edition' %}
                                                <div class="fw-bold text-primary">Ad #{{ loop.index }}</div>
                                                <div class="text-success">{{ "%.0f"|format(box.column_inches) }}" inches</div>
                                                <div class="small text-muted">
                                                    {% if box.column_inches == 14.04 %}1/8 Page{% endif %}
                                                    {% if box.column_inches == 28.88 %}1/4 Page{% endif %}
                                                    {% if box.column_inches == 59.28 %}1/2 Page{% endif %}
                                                    {% if box.column_inches == 120.24 %}Full Page{% endif %}
                                                </div>
                                            {% else %}
                                                <div class="fw-bold text-primary">{{ "%.1f"|format(box.column_inches) }}" inches</div>
                                                <div class="small text-muted">
                                                    {{ "%.2f"|format(box.width_inches_raw) }}" × {{ "%.2f"|format(box.height_inches_raw) }}"
                                                </div>
                                                {% if publication.publication_type == 'broadsheet' and box.ad_type and box.ad_type != 'manual' %}
                                                <div class="small text-success">
                                                    {{ box.ad_type.replace('_', ' ').upper() }}
                                                </div>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                        <div class="text-end">
                                            {% if box.user_verified %}
                                                <i class="fas fa-check-circle text-success" title="User verified"></i>
                                            {% else %}
                                                <i class="fas fa-robot text-info" title="AI detected"></i>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let isSpecialEdition = {{ 'true' if publication.publication_type == 'special_edition' else 'false' }};
let markerCounter = {{ ad_boxes|length + 1 }};
let currentZoom = 1.0;
let minZoom = 0.25;
let maxZoom = 3.0;
let zoomStep = 0.25;
let lastMeasuredAd = null; // Store the last measured ad for copying
let pendingTemplateSaves = new Set(); // Track boxes that need templates saved

// Auto-scroll function for when resizing ad boxes near viewport edges
function autoScrollDuringResize(boxX, boxY, boxWidth, boxHeight, mouseX, mouseY) {
    const pageViewer = document.querySelector('.page-viewer');
    if (!pageViewer) return;
    
    const scrollBuffer = 50; // Distance from edge to start scrolling
    const scrollSpeed = 10;  // Pixels to scroll per frame
    
    // Get viewport dimensions and scroll position
    const viewerRect = pageViewer.getBoundingClientRect();
    const scrollTop = pageViewer.scrollTop;
    const scrollLeft = pageViewer.scrollLeft;
    
    // Calculate box edges in viewport coordinates
    const pageContainer = document.getElementById('pageContainer');
    const containerRect = pageContainer.getBoundingClientRect();
    
    // Convert box coordinates to viewport coordinates
    const boxTop = containerRect.top + (boxY * currentZoom);
    const boxBottom = boxTop + (boxHeight * currentZoom);
    const boxLeft = containerRect.left + (boxX * currentZoom);
    const boxRight = boxLeft + (boxWidth * currentZoom);
    
    let scrollX = 0;
    let scrollY = 0;
    
    // Check if we need to scroll vertically
    if (boxBottom > viewerRect.bottom - scrollBuffer) {
        // Need to scroll down
        scrollY = scrollSpeed;
    } else if (boxTop < viewerRect.top + scrollBuffer) {
        // Need to scroll up
        scrollY = -scrollSpeed;
    }
    
    // Check if we need to scroll horizontally
    if (boxRight > viewerRect.right - scrollBuffer) {
        // Need to scroll right
        scrollX = scrollSpeed;
    } else if (boxLeft < viewerRect.left + scrollBuffer) {
        // Need to scroll left
        scrollX = -scrollSpeed;
    }
    
    // Apply scrolling if needed
    if (scrollX !== 0 || scrollY !== 0) {
        pageViewer.scrollTo({
            left: scrollLeft + scrollX,
            top: scrollTop + scrollY,
            behavior: 'auto' // Instant scrolling for smooth resizing
        });
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    if (isSpecialEdition) {
        setupSpecialEditionInterface();
    } else {
        if ({{ 'true' if publication.publication_type == 'broadsheet' else 'false' }}) {
            initializeBroadsheetInterface();
        } else {
            initializeRegularInterface();
        }
    }
    setupKeyboardNavigation();
    setupZoomControls();
    
    // Initialize full-page ad functionality
    setupFullPageAdButton();
    
    // Initialize copy ad functionality
    setupCopyAdButton();

    // Initialize template matching functionality
    setupMatchTemplatesButton();

    // Initialize copy button based on existing ad boxes
    initializeCopyButtonState();
    
    // Auto-fit the page to container width
    autoFitPageToContainer();
});

// Auto-fit page image to container width
function autoFitPageToContainer() {
    const pageImage = document.getElementById('pageImage');
    const pageViewer = document.getElementById('pageViewer');
    
    if (!pageImage || !pageViewer) return;
    
    // Wait for image to load
    if (pageImage.complete) {
        calculateAndApplyFitZoom();
    } else {
        pageImage.onload = function() {
            calculateAndApplyFitZoom();
        };
    }
}

function calculateAndApplyFitZoom() {
    const pageImage = document.getElementById('pageImage');
    const pageViewer = document.getElementById('pageViewer');
    
    if (!pageImage || !pageViewer) return;
    
    // Set to 75% zoom level for consistent starting point
    const defaultZoom = 0.75;
    
    // Apply the zoom
    currentZoom = defaultZoom;
    applyZoom();
    
    console.log(`Page loaded at 75% zoom for consistent viewing`);
}

// Keep the smart fit function for the "Fit to Screen" button
function calculateAndApplySmartFit() {
    const pageImage = document.getElementById('pageImage');
    const pageViewer = document.getElementById('pageViewer');
    
    if (!pageImage || !pageViewer) return;
    
    // Get container dimensions (subtract some padding for scrollbars and margins)
    const containerWidth = pageViewer.clientWidth - 40; // 40px for margins/scrollbars
    const containerHeight = pageViewer.clientHeight - 40;
    
    // Get image natural dimensions
    const imageWidth = pageImage.naturalWidth || pageImage.width;
    const imageHeight = pageImage.naturalHeight || pageImage.height;
    
    if (imageWidth === 0 || imageHeight === 0) return;
    
    // Calculate zoom levels to fit width and height
    const zoomToFitWidth = containerWidth / imageWidth;
    const zoomToFitHeight = containerHeight / imageHeight;
    
    // Use the smaller zoom level to ensure the entire image fits
    const optimalZoom = Math.min(zoomToFitWidth, zoomToFitHeight);
    
    // Constrain to our zoom limits
    const finalZoom = Math.max(minZoom, Math.min(maxZoom, optimalZoom));
    
    // Apply the zoom
    currentZoom = finalZoom;
    applyZoom();
    
    console.log(`Smart-fit: Container ${containerWidth}x${containerHeight}, Image ${imageWidth}x${imageHeight}, Zoom: ${(finalZoom * 100).toFixed(1)}%`);
}

// Note: Window resize auto-fit removed to maintain consistent 75% zoom
// Users can manually use "Fit to Screen" button if needed after resize

// Full-page Ad functionality (Broadsheet only)
function setupFullPageAdButton() {
    const fullPageAdBtn = document.getElementById('fullPageAdBtn');
    
    if (fullPageAdBtn) {
        fullPageAdBtn.addEventListener('click', function() {
            addFullPageAd();
        });
    }
}

// Copy Ad functionality
function setupCopyAdButton() {
    const copyAdBtn = document.getElementById('copyAdBtn');
    
    if (copyAdBtn) {
        copyAdBtn.addEventListener('click', function() {
            if (lastMeasuredAd) {
                copyLastMeasuredAd();
            } else {
                showErrorMessage('No ad measurement to copy. Please create or measure an ad first.');
            }
        });
    }
}

// Template Matching functionality
function setupMatchTemplatesButton() {
    const matchTemplatesBtn = document.getElementById('matchTemplatesBtn');

    if (matchTemplatesBtn) {
        matchTemplatesBtn.addEventListener('click', function() {
            matchTemplates();
        });
    }
}

function matchTemplates() {
    // Show loading indicator
    const matchTemplatesBtn = document.getElementById('matchTemplatesBtn');
    const originalText = matchTemplatesBtn.innerHTML;
    matchTemplatesBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Matching...';
    matchTemplatesBtn.disabled = true;

    console.log('🔍 Starting template matching...');

    fetch(`/api/match_templates/{{ page.id }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('📊 Template matching response:', data);

        // Reset button
        matchTemplatesBtn.innerHTML = originalText;
        matchTemplatesBtn.disabled = false;

        if (data.success) {
            if (data.matches && data.matches > 0) {
                showSuccessMessage(`✅ Found ${data.matches} template matches! New ad boxes have been added.`);
                // Refresh the page to show new ad boxes
                window.location.reload();
            } else {
                showSuccessMessage('ℹ️ No template matches found on this page.');
            }
        } else {
            showErrorMessage('❌ Error matching templates: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('❌ Template matching error:', error);
        showErrorMessage('❌ Network error occurred while matching templates');

        // Reset button
        matchTemplatesBtn.innerHTML = originalText;
        matchTemplatesBtn.disabled = false;
    });
}

function addFullPageAd() {
    // Show loading indicator
    const fullPageAdBtn = document.getElementById('fullPageAdBtn');
    const originalText = fullPageAdBtn.innerHTML;
    fullPageAdBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
    fullPageAdBtn.disabled = true;
    
    // Get page image dimensions
    const pageImage = document.getElementById('pageImage');
    const imageWidth = pageImage.naturalWidth || pageImage.width;
    const imageHeight = pageImage.naturalHeight || pageImage.height;
    
    // Create full-page box data (covers entire image with small margin)
    const margin = 10; // Small margin so box is visible within page bounds
    const fullPageData = {
        x: margin,
        y: margin,
        width: imageWidth - (margin * 2),
        height: imageHeight - (margin * 2),
        ad_type: 'full_page',
        column_inches: 258, // Full broadsheet page
        is_full_page: true
    };
    
    // Call API to add full-page ad
    fetch(`/api/add_full_page_ad/{{ page.id }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(fullPageData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove all existing ad boxes from the page
            document.querySelectorAll('.ad-box, .measurement-box, .ad-marker').forEach(box => {
                box.remove();
            });
            
            // Create full-page visual box
            createFullPageVisualBox(data);
            
            // Update measurements panel
            updateMeasurementsPanelForFullPage(data);
            
            // Update page total
            updatePageTotalForFullPage();
            
            // Show success message
            showSuccessMessage('Full-page advertisement added successfully!');
            
        } else {
            showErrorMessage('Error adding full-page ad: ' + data.error);
        }
        
        // Reset button
        fullPageAdBtn.innerHTML = originalText;
        fullPageAdBtn.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorMessage('Network error occurred');
        
        // Reset button
        fullPageAdBtn.innerHTML = originalText;
        fullPageAdBtn.disabled = false;
    });
}

function createFullPageVisualBox(data) {
    const pageContainer = document.getElementById('pageContainer');
    
    // Create full-page ad box element
    const fullPageBox = document.createElement('div');
    fullPageBox.className = 'ad-box full-page-ad';
    fullPageBox.dataset.boxId = data.box_id;
    fullPageBox.style.position = 'absolute';
    fullPageBox.style.left = data.x + 'px';
    fullPageBox.style.top = data.y + 'px';
    fullPageBox.style.width = data.width + 'px';
    fullPageBox.style.height = data.height + 'px';
    fullPageBox.style.border = '3px solid #ffc107'; // Yellow border for full-page
    fullPageBox.style.backgroundColor = 'rgba(255, 193, 7, 0.15)'; // Yellow background
    fullPageBox.style.cursor = 'default'; // Not draggable
    fullPageBox.style.zIndex = '5'; // Lower z-index so it stays behind other elements
    
    // Add full-page label
    const label = document.createElement('div');
    label.className = 'ad-label full-page-label';
    label.style.position = 'absolute';
    label.style.top = '50%';
    label.style.left = '50%';
    label.style.transform = 'translate(-50%, -50%)';
    label.style.background = 'rgba(255, 193, 7, 0.9)';
    label.style.color = '#000';
    label.style.padding = '10px 20px';
    label.style.borderRadius = '5px';
    label.style.fontSize = '18px';
    label.style.fontWeight = 'bold';
    label.style.textAlign = 'center';
    label.innerHTML = 'FULL-PAGE AD<br>258 inches';
    fullPageBox.appendChild(label);
    
    // Add delete button
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-btn';
    deleteBtn.innerHTML = '×';
    deleteBtn.style.position = 'absolute';
    deleteBtn.style.top = '10px';
    deleteBtn.style.right = '10px';
    deleteBtn.style.background = '#dc3545';
    deleteBtn.style.color = 'white';
    deleteBtn.style.border = 'none';
    deleteBtn.style.borderRadius = '50%';
    deleteBtn.style.width = '30px';
    deleteBtn.style.height = '30px';
    deleteBtn.style.fontSize = '16px';
    deleteBtn.style.cursor = 'pointer';
    deleteBtn.style.zIndex = '10';
    deleteBtn.onclick = function(e) {
        e.stopPropagation();
        deleteFullPageAd(data.box_id);
    };
    fullPageBox.appendChild(deleteBtn);
    
    pageContainer.appendChild(fullPageBox);
}

function updateMeasurementsPanelForFullPage(data) {
    const adBoxesList = document.getElementById('adBoxesList');
    
    // Clear existing list
    adBoxesList.innerHTML = '';
    
    // Add full-page ad to list
    const adItem = document.createElement('div');
    adItem.className = 'ad-item full-page-item';
    adItem.dataset.boxId = data.box_id;
    adItem.style.border = '2px solid #ffc107';
    adItem.style.backgroundColor = 'rgba(255, 193, 7, 0.1)';
    
    adItem.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <div class="fw-bold text-warning" style="font-size: 1.2em;">
                    <i class="fas fa-newspaper"></i> FULL-PAGE AD
                </div>
                <div class="text-success" style="font-size: 1.1em; font-weight: bold;">
                    258.0 inches
                </div>
                <div class="small text-muted">
                    Complete page coverage
                </div>
            </div>
            <div class="text-end">
                <i class="fas fa-check-circle text-success" title="User created"></i>
            </div>
        </div>
    `;
    
    adBoxesList.appendChild(adItem);
}

function updatePageTotalForFullPage() {
    const totalElement = document.getElementById('pageTotalInches');
    totalElement.textContent = '258';
    
    // Add visual feedback
    totalElement.parentElement.classList.add('measurements-updated');
    setTimeout(() => {
        totalElement.parentElement.classList.remove('measurements-updated');
    }, 1000);
}

// Copy the last measured ad functionality
function copyLastMeasuredAd() {
    if (!lastMeasuredAd) {
        showErrorMessage('No ad measurement to copy.');
        return;
    }
    
    // Show loading indicator
    const copyAdBtn = document.getElementById('copyAdBtn');
    const originalText = copyAdBtn.innerHTML;
    copyAdBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Copying...';
    copyAdBtn.disabled = true;
    
    // Create a copy of the last measured ad with a slight offset so it's visible
    const offset = 20;
    const copiedAdData = {
        x: lastMeasuredAd.x + offset,
        y: lastMeasuredAd.y + offset,
        width: lastMeasuredAd.width,
        height: lastMeasuredAd.height,
        ad_type: lastMeasuredAd.ad_type || 'manual',
        // Pass the exact measurements to preserve them
        width_raw: lastMeasuredAd.width_raw || 0,
        height_raw: lastMeasuredAd.height_raw || 0,
        width_rounded: lastMeasuredAd.width_rounded || 0,
        height_rounded: lastMeasuredAd.height_rounded || 0,
        column_inches: lastMeasuredAd.column_inches || 0
    };
    
    console.log('Copying ad with data:', copiedAdData);
    console.log('Last measured ad was:', lastMeasuredAd);
    
    // Use the copy API endpoint to preserve exact measurements if we have them,
    // otherwise fall back to manual box creation
    let apiEndpoint = '/api/copy_ad_box/{{ page.id }}';
    
    // If we don't have detailed measurements (e.g., from page load initialization),
    // fall back to regular manual box creation
    if (!lastMeasuredAd.width_raw && !lastMeasuredAd.height_raw && !lastMeasuredAd.column_inches) {
        apiEndpoint = '/api/add_manual_box/{{ page.id }}';
        // Remove the measurement fields for the manual API
        delete copiedAdData.width_raw;
        delete copiedAdData.height_raw;
        delete copiedAdData.width_rounded;
        delete copiedAdData.height_rounded;
        delete copiedAdData.column_inches;
    }
    
    fetch(apiEndpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(copiedAdData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Create the visual ad box
            createCopiedAdBox(data);
            
            // Update measurements panel
            addBoxToMeasurementsList(data);
            
            // Update page total
            updatePageTotalRegular();
            
            // Update lastMeasuredAd to the new copied ad
            updateLastMeasuredAd(data);
            
            showSuccessMessage('Ad measurement copied successfully!');
        } else {
            showErrorMessage('Error copying ad measurement: ' + data.error);
        }
        
        // Reset button
        copyAdBtn.innerHTML = originalText;
        copyAdBtn.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorMessage('Network error occurred while copying ad');
        
        // Reset button
        copyAdBtn.innerHTML = originalText;
        copyAdBtn.disabled = false;
    });
}

function createCopiedAdBox(data) {
    const pageContainer = document.getElementById('pageContainer');
    
    // Create the ad box element
    const adBox = document.createElement('div');
    adBox.className = 'ad-box manual-box';
    adBox.dataset.boxId = data.box_id;
    adBox.style.position = 'absolute';
    adBox.style.left = data.x + 'px';
    adBox.style.top = data.y + 'px';
    adBox.style.width = data.width + 'px';
    adBox.style.height = data.height + 'px';
    adBox.style.border = '2px solid #007bff';
    adBox.style.background = 'rgba(0, 123, 255, 0.1)';
    adBox.style.cursor = 'move';
    adBox.style.userSelect = 'none';
    
    // Add label
    const label = document.createElement('div');
    label.className = 'ad-label';
    label.style.position = 'absolute';
    label.style.top = '2px';
    label.style.left = '2px';
    label.style.background = 'rgba(0, 123, 255, 0.9)';
    label.style.color = 'white';
    label.style.padding = '2px 6px';
    label.style.fontSize = '11px';
    label.style.borderRadius = '3px';
    label.style.fontWeight = 'bold';
    label.style.pointerEvents = 'none';
    label.textContent = data.column_inches.toFixed(1) + '"';
    adBox.appendChild(label);
    
    // Add delete button
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-btn';
    deleteBtn.innerHTML = '×';
    deleteBtn.style.position = 'absolute';
    deleteBtn.style.top = '-8px';
    deleteBtn.style.right = '-8px';
    deleteBtn.style.background = '#dc3545';
    deleteBtn.style.color = 'white';
    deleteBtn.style.border = 'none';
    deleteBtn.style.borderRadius = '50%';
    deleteBtn.style.width = '18px';
    deleteBtn.style.height = '18px';
    deleteBtn.style.fontSize = '12px';
    deleteBtn.style.cursor = 'pointer';
    deleteBtn.style.display = 'flex';
    deleteBtn.style.alignItems = 'center';
    deleteBtn.style.justifyContent = 'center';
    deleteBtn.style.zIndex = '10';
    deleteBtn.onclick = function(e) {
        e.stopPropagation();
        deleteAdBox(data.box_id);
    };
    adBox.appendChild(deleteBtn);
    
    // Make it draggable
    makeDraggable(adBox);
    
    pageContainer.appendChild(adBox);
}

// Update last measured ad and enable copy button
function updateLastMeasuredAd(adData) {
    console.log('updateLastMeasuredAd called with data:', adData);
    
    lastMeasuredAd = {
        x: adData.x,
        y: adData.y,
        width: adData.width,
        height: adData.height,
        ad_type: adData.ad_type || 'manual',
        column_inches: adData.column_inches,
        // Store the exact measurements returned by the server
        width_raw: adData.width_raw,
        height_raw: adData.height_raw,
        width_rounded: adData.width_rounded,
        height_rounded: adData.height_rounded
    };
    
    console.log('lastMeasuredAd updated to:', lastMeasuredAd);
    
    // Enable the copy button
    const copyAdBtn = document.getElementById('copyAdBtn');
    if (copyAdBtn) {
        copyAdBtn.disabled = false;
        copyAdBtn.title = `Copy last measured ad (${adData.column_inches.toFixed(1)}" inches)`;
    }
}

// Initialize copy button state based on existing ad boxes
function initializeCopyButtonState() {
    // Check if there are any existing ad boxes
    const existingBoxes = document.querySelectorAll('.ad-box, .measurement-box');
    if (existingBoxes.length > 0) {
        // Get the last (most recently added) box's data
        const lastBox = existingBoxes[existingBoxes.length - 1];
        const boxId = lastBox.dataset.boxId;
        
        // Extract box dimensions and position
        const rect = lastBox.getBoundingClientRect();
        const pageContainer = document.getElementById('pageContainer');
        const containerRect = pageContainer.getBoundingClientRect();
        
        // Calculate relative position to page container
        const x = parseInt(lastBox.style.left) || 0;
        const y = parseInt(lastBox.style.top) || 0;
        const width = parseInt(lastBox.style.width) || rect.width;
        const height = parseInt(lastBox.style.height) || rect.height;
        
        // Try to get column inches from the ad label or calculate it
        let columnInches = 0;
        const label = lastBox.querySelector('.ad-label');
        if (label && label.textContent) {
            const match = label.textContent.match(/(\d+\.?\d*)/);
            if (match) {
                columnInches = parseFloat(match[1]);
            }
        }
        
        // Set up lastMeasuredAd with the most recent box
        lastMeasuredAd = {
            x: x,
            y: y,
            width: width,
            height: height,
            ad_type: 'manual', // Default to manual for existing boxes
            column_inches: columnInches
        };
        
        // Enable the copy button
        const copyAdBtn = document.getElementById('copyAdBtn');
        if (copyAdBtn && columnInches > 0) {
            copyAdBtn.disabled = false;
            copyAdBtn.title = `Copy last measured ad (${columnInches.toFixed(1)}" inches)`;
        }
    }
}

function deleteFullPageAd(boxId) {
    attemptDeleteFullPageAd(boxId, 1);
}

function attemptDeleteFullPageAd(boxId, attempt) {
    const maxAttempts = 2;
    
    fetch(`/api/delete_box/${boxId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove visual element
            const boxElement = document.querySelector(`[data-box-id="${boxId}"]`);
            if (boxElement) {
                boxElement.remove();
            }
            
            // Clear measurements list
            const adBoxesList = document.getElementById('adBoxesList');
            adBoxesList.innerHTML = '';
            
            // Reset page total
            const totalElement = document.getElementById('pageTotalInches');
            totalElement.textContent = '0';
            
            showSuccessMessage('Full-page ad deleted successfully');
        } else {
            if (data.error && data.error.includes('Database transaction error') && attempt < maxAttempts) {
                setTimeout(() => attemptDeleteFullPageAd(boxId, attempt + 1), 1000);
            } else {
                let errorMsg = data.error || 'Unknown error occurred';
                if (errorMsg.includes('Database transaction error')) {
                    errorMsg += ' Please refresh the page if this persists.';
                }
                showErrorMessage('Error deleting full-page ad: ' + errorMsg);
            }
        }
    })
    .catch(error => {
        console.error('Error deleting full-page ad:', error);
        if (attempt < maxAttempts) {
            setTimeout(() => attemptDeleteFullPageAd(boxId, attempt + 1), 1000);
        } else {
            showErrorMessage('Network error occurred. Please check your connection and try again.');
        }
    });
}


function createManualBoxElement(data) {
    const pageContainer = document.getElementById('pageContainer');
    
    // Create manual box element
    const manualBox = document.createElement('div');
    manualBox.className = 'measurement-box manual-box';
    manualBox.dataset.boxId = data.box_id;
    manualBox.style.position = 'absolute';
    manualBox.style.left = data.x + 'px';
    manualBox.style.top = data.y + 'px';
    manualBox.style.width = data.width + 'px';
    manualBox.style.height = data.height + 'px';
    manualBox.style.border = '2px solid #6f42c1';
    manualBox.style.backgroundColor = 'rgba(111, 66, 193, 0.1)';
    manualBox.style.cursor = 'move';
    manualBox.style.zIndex = '50';
    
    // Add resize handles
    const handles = ['nw', 'ne', 'sw', 'se', 'n', 's', 'w', 'e'];
    handles.forEach(handle => {
        const handleElement = document.createElement('div');
        handleElement.className = `resize-handle ${handle}`;
        handleElement.style.background = '#6f42c1';
        handleElement.style.border = '1px solid white';
        handleElement.style.width = '10px';
        handleElement.style.height = '10px';
        handleElement.style.position = 'absolute';
        handleElement.style.zIndex = '100';
        
        // Position handles
        switch(handle) {
            case 'nw':
                handleElement.style.top = '-5px';
                handleElement.style.left = '-5px';
                handleElement.style.cursor = 'nw-resize';
                break;
            case 'ne':
                handleElement.style.top = '-5px';
                handleElement.style.right = '-5px';
                handleElement.style.cursor = 'ne-resize';
                break;
            case 'sw':
                handleElement.style.bottom = '-5px';
                handleElement.style.left = '-5px';
                handleElement.style.cursor = 'sw-resize';
                break;
            case 'se':
                handleElement.style.bottom = '-5px';
                handleElement.style.right = '-5px';
                handleElement.style.cursor = 'se-resize';
                break;
            case 'n':
                handleElement.style.top = '-5px';
                handleElement.style.left = '50%';
                handleElement.style.transform = 'translateX(-50%)';
                handleElement.style.cursor = 'n-resize';
                break;
            case 's':
                handleElement.style.bottom = '-5px';
                handleElement.style.left = '50%';
                handleElement.style.transform = 'translateX(-50%)';
                handleElement.style.cursor = 's-resize';
                break;
            case 'w':
                handleElement.style.top = '50%';
                handleElement.style.left = '-5px';
                handleElement.style.transform = 'translateY(-50%)';
                handleElement.style.cursor = 'w-resize';
                break;
            case 'e':
                handleElement.style.top = '50%';
                handleElement.style.right = '-5px';
                handleElement.style.transform = 'translateY(-50%)';
                handleElement.style.cursor = 'e-resize';
                break;
        }
        
        manualBox.appendChild(handleElement);
    });
    
    // Add label
    const label = document.createElement('div');
    label.className = 'ad-label';
    label.style.position = 'absolute';
    label.style.top = '2px';
    label.style.left = '2px';
    label.style.background = 'rgba(111, 66, 193, 0.9)';
    label.style.color = 'white';
    label.style.padding = '2px 6px';
    label.style.fontSize = '11px';
    label.style.borderRadius = '3px';
    label.style.fontWeight = 'bold';
    label.style.pointerEvents = 'none';
    label.style.zIndex = '10';
    label.innerHTML = `${data.column_inches.toFixed(1)}" (manual)`;
    manualBox.appendChild(label);
    
    // Add delete button
    const deleteHandle = document.createElement('div');
    deleteHandle.className = 'delete-handle';
    deleteHandle.innerHTML = '×';
    deleteHandle.title = 'Delete this manual box';
    deleteHandle.style.position = 'absolute';
    deleteHandle.style.top = '-10px';
    deleteHandle.style.right = '-10px';
    deleteHandle.style.width = '20px';
    deleteHandle.style.height = '20px';
    deleteHandle.style.background = '#6f42c1';
    deleteHandle.style.color = 'white';
    deleteHandle.style.borderRadius = '50%';
    deleteHandle.style.display = 'flex';
    deleteHandle.style.alignItems = 'center';
    deleteHandle.style.justifyContent = 'center';
    deleteHandle.style.cursor = 'pointer';
    deleteHandle.style.fontSize = '12px';
    deleteHandle.style.fontWeight = 'bold';
    deleteHandle.style.border = '2px solid white';
    deleteHandle.style.zIndex = '100';
    deleteHandle.onclick = function(e) {
        e.stopPropagation();
        deleteAdBox(data.box_id);
    };
    manualBox.appendChild(deleteHandle);
    
    pageContainer.appendChild(manualBox);
    
    // Initialize custom manual box interaction
    initializeManualBoxInteraction(manualBox);
    
    // Update last measured ad for copying
    updateLastMeasuredAd(data);
}

function initializeManualBoxInteraction(box) {
    const boxId = box.dataset.boxId;
    let isDragging = false;
    let isResizing = false;
    let currentHandle = null;
    let startMouseX = 0;
    let startMouseY = 0;
    let startBoxX = 0;
    let startBoxY = 0;
    let startBoxWidth = 0;
    let startBoxHeight = 0;
    
    // Box dragging (click on box itself, not handles)
    box.addEventListener('mousedown', function(e) {
        // Don't drag if clicking on handles or delete button
        if (e.target.classList.contains('resize-handle') || 
            e.target.classList.contains('delete-handle') ||
            e.target.classList.contains('ad-label')) {
            return;
        }
        
        e.preventDefault();
        e.stopPropagation();
        
        isDragging = true;
        startMouseX = e.clientX;
        startMouseY = e.clientY;
        startBoxX = parseInt(box.style.left);
        startBoxY = parseInt(box.style.top);
        
        box.style.cursor = 'grabbing';
        
        const onMouseMove = function(e) {
            if (!isDragging) return;
            
            const deltaX = (e.clientX - startMouseX) / currentZoom;
            const deltaY = (e.clientY - startMouseY) / currentZoom;
            
            const newX = startBoxX + deltaX;
            const newY = startBoxY + deltaY;
            
            // Keep within bounds
            const pageImage = document.getElementById('pageImage');
            const maxX = (pageImage.naturalWidth || pageImage.width) - parseInt(box.style.width);
            const maxY = (pageImage.naturalHeight || pageImage.height) - parseInt(box.style.height);
            
            const constrainedX = Math.max(0, Math.min(newX, maxX));
            const constrainedY = Math.max(0, Math.min(newY, maxY));
            
            box.style.left = constrainedX + 'px';
            box.style.top = constrainedY + 'px';
            
            // Auto-scroll functionality when dragging near viewport edges
            const boxWidth = parseInt(box.style.width);
            const boxHeight = parseInt(box.style.height);
            autoScrollDuringResize(constrainedX, constrainedY, boxWidth, boxHeight, e.clientX, e.clientY);
        };
        
        const onMouseUp = function(e) {
            if (!isDragging) return;
            isDragging = false;
            box.style.cursor = 'move';
            
            // Update in database
            updateManualBoxInDatabase(boxId, {
                x: parseInt(box.style.left),
                y: parseInt(box.style.top),
                width: parseInt(box.style.width),
                height: parseInt(box.style.height)
            });
            
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        };
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    });
    
    // Handle resizing
    box.querySelectorAll('.resize-handle').forEach(handle => {
        handle.addEventListener('mousedown', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            isResizing = true;
            currentHandle = handle.classList[1]; // Get handle type (nw, ne, etc.)
            startMouseX = e.clientX;
            startMouseY = e.clientY;
            startBoxX = parseInt(box.style.left);
            startBoxY = parseInt(box.style.top);
            startBoxWidth = parseInt(box.style.width);
            startBoxHeight = parseInt(box.style.height);
            
            const onMouseMove = function(e) {
                if (!isResizing) return;
                
                const deltaX = (e.clientX - startMouseX) / currentZoom;
                const deltaY = (e.clientY - startMouseY) / currentZoom;
                
                let newX = startBoxX;
                let newY = startBoxY;
                let newWidth = startBoxWidth;
                let newHeight = startBoxHeight;
                
                // Calculate new dimensions based on handle type
                switch(currentHandle) {
                    case 'nw':
                        newX = startBoxX + deltaX;
                        newY = startBoxY + deltaY;
                        newWidth = startBoxWidth - deltaX;
                        newHeight = startBoxHeight - deltaY;
                        break;
                    case 'ne':
                        newY = startBoxY + deltaY;
                        newWidth = startBoxWidth + deltaX;
                        newHeight = startBoxHeight - deltaY;
                        break;
                    case 'sw':
                        newX = startBoxX + deltaX;
                        newWidth = startBoxWidth - deltaX;
                        newHeight = startBoxHeight + deltaY;
                        break;
                    case 'se':
                        newWidth = startBoxWidth + deltaX;
                        newHeight = startBoxHeight + deltaY;
                        break;
                    case 'n':
                        newY = startBoxY + deltaY;
                        newHeight = startBoxHeight - deltaY;
                        break;
                    case 's':
                        newHeight = startBoxHeight + deltaY;
                        break;
                    case 'w':
                        newX = startBoxX + deltaX;
                        newWidth = startBoxWidth - deltaX;
                        break;
                    case 'e':
                        newWidth = startBoxWidth + deltaX;
                        break;
                }
                
                // Enforce minimum size
                if (newWidth < 20) {
                    newWidth = 20;
                    if (currentHandle.includes('w')) {
                        newX = startBoxX + startBoxWidth - 20;
                    }
                }
                if (newHeight < 20) {
                    newHeight = 20;
                    if (currentHandle.includes('n')) {
                        newY = startBoxY + startBoxHeight - 20;
                    }
                }
                
                // Keep within bounds
                const pageImage = document.getElementById('pageImage');
                const maxX = (pageImage.naturalWidth || pageImage.width) - newWidth;
                const maxY = (pageImage.naturalHeight || pageImage.height) - newHeight;
                newX = Math.max(0, Math.min(newX, maxX));
                newY = Math.max(0, Math.min(newY, maxY));
                
                // Apply changes
                box.style.left = newX + 'px';
                box.style.top = newY + 'px';
                box.style.width = newWidth + 'px';
                box.style.height = newHeight + 'px';
                
                // Auto-scroll functionality when resizing near viewport edges
                autoScrollDuringResize(newX, newY, newWidth, newHeight, e.clientX, e.clientY);
                
                // Update label
                updateManualBoxLabel(box, newWidth, newHeight);
            };
            
            const onMouseUp = function(e) {
                if (!isResizing) return;
                isResizing = false;
                currentHandle = null;
                
                // Update in database
                updateManualBoxInDatabase(boxId, {
                    x: parseInt(box.style.left),
                    y: parseInt(box.style.top),
                    width: parseInt(box.style.width),
                    height: parseInt(box.style.height)
                });
                
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            };
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    });
}

function updateManualBoxLabel(box, width, height) {
    // Simple calculation for display - actual calculation happens server-side
    const approximateInches = (width * height) / 2500; // Rough approximation
    const label = box.querySelector('.ad-label');
    if (label) {
        label.innerHTML = `${approximateInches.toFixed(1)}" (manual)`;
    }
}


function updateManualBoxInDatabase(boxId, boxData) {
    fetch(`/api/update_manual_box/${boxId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(boxData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update measurements in the sidebar list
            updateManualBoxInSidebar(boxId, data);
            updatePageTotalRegular();

            // Mark this box to have its template saved later
            pendingTemplateSaves.add(boxId);

            // Update last measured ad for copying (this was missing!)
            updateLastMeasuredAd(data);
        } else {
            console.error('Error updating manual box:', data.error);
        }
    })
    .catch(error => {
        console.error('Error updating manual box:', error);
    });
}

function updateManualBoxInSidebar(boxId, data) {
    const listItem = document.querySelector(`.ad-item[data-box-id="${boxId}"]`);
    if (listItem) {
        listItem.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="fw-bold text-primary">${data.column_inches.toFixed(1)}" inches</div>
                    <div class="small text-muted">
                        ${data.width_raw.toFixed(2)}" × ${data.height_raw.toFixed(2)}"
                    </div>
                    <div class="small text-info">
                        MANUAL
                    </div>
                </div>
                <div class="text-end">
                    <i class="fas fa-check-circle text-success" title="User created"></i>
                </div>
            </div>
        `;
        
        // Add visual feedback
        listItem.classList.add('measurements-updated');
        setTimeout(() => {
            listItem.classList.remove('measurements-updated');
        }, 500);
    }
}

// Keyboard navigation
function setupKeyboardNavigation() {
    document.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowLeft' && {{ current_page }} > 1) {
            // Save templates before leaving page
            savePendingTemplates();
            window.location.href = "{{ url_for('measure_page', pub_id=publication.id, page_num=current_page-1) }}";
        } else if (e.key === 'ArrowRight' && {{ current_page }} < {{ total_pages }}) {
            // Save templates before leaving page
            savePendingTemplates();
            window.location.href = "{{ url_for('measure_page', pub_id=publication.id, page_num=current_page+1) }}";
        }
    });
}

// Save templates when page is about to unload
window.addEventListener('beforeunload', function() {
    savePendingTemplates();
});

// Zoom Controls
function setupZoomControls() {
    const zoomInBtn = document.getElementById('zoomInBtn');
    const zoomOutBtn = document.getElementById('zoomOutBtn');
    const zoomResetBtn = document.getElementById('zoomResetBtn');
    const fitToScreenBtn = document.getElementById('fitToScreenBtn');
    const pageContainer = document.getElementById('pageContainer');
    const pageViewer = document.getElementById('pageViewer');
    
    if (zoomInBtn) {
        zoomInBtn.addEventListener('click', function() {
            zoomIn();
        });
    }
    
    if (zoomOutBtn) {
        zoomOutBtn.addEventListener('click', function() {
            zoomOut();
        });
    }
    
    if (zoomResetBtn) {
        zoomResetBtn.addEventListener('click', function() {
            resetZoom();
        });
    }
    
    if (fitToScreenBtn) {
        fitToScreenBtn.addEventListener('click', function() {
            calculateAndApplySmartFit();
        });
    }
    
    // Mouse wheel zoom (optional enhancement)
    if (pageViewer) {
        pageViewer.addEventListener('wheel', function(e) {
            if (e.ctrlKey) {
                e.preventDefault();
                if (e.deltaY < 0) {
                    zoomIn();
                } else {
                    zoomOut();
                }
            }
        });
    }
}

function zoomIn() {
    if (currentZoom < maxZoom) {
        currentZoom += zoomStep;
        applyZoom();
    }
}

function zoomOut() {
    if (currentZoom > minZoom) {
        currentZoom -= zoomStep;
        applyZoom();
    }
}

function resetZoom() {
    currentZoom = 1.0;
    applyZoom();
}

function applyZoom() {
    const pageContainer = document.getElementById('pageContainer');
    const pageImage = document.getElementById('pageImage');
    const zoomLevel = document.getElementById('zoomLevel');
    
    if (pageContainer && pageImage) {
        // Apply zoom transform
        pageContainer.style.transform = `scale(${currentZoom})`;
        pageContainer.style.transformOrigin = 'top left';
        
        // Update zoom level display
        if (zoomLevel) {
            zoomLevel.textContent = Math.round(currentZoom * 100) + '%';
        }
        
        // Update button states
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        
        if (zoomInBtn) {
            zoomInBtn.disabled = currentZoom >= maxZoom;
        }
        if (zoomOutBtn) {
            zoomOutBtn.disabled = currentZoom <= minZoom;
        }
        
        // Adjust container size to accommodate zoom
        const viewer = document.getElementById('pageViewer');
        if (viewer) {
            const naturalWidth = pageImage.naturalWidth || pageImage.width;
            const naturalHeight = pageImage.naturalHeight || pageImage.height;
            
            // Set container size based on zoom
            pageContainer.style.width = (naturalWidth * currentZoom) + 'px';
            pageContainer.style.height = (naturalHeight * currentZoom) + 'px';
        }
    }
}

// Special Edition Interface
function setupSpecialEditionInterface() {
    const pageContainer = document.getElementById('pageContainer');
    const contextMenu = document.getElementById('contextMenu');
    let clickX, clickY;
    
    // Right-click context menu
    pageContainer.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        
        const rect = pageContainer.getBoundingClientRect();
        // Adjust coordinates for zoom level
        clickX = (e.clientX - rect.left) / currentZoom;
        clickY = (e.clientY - rect.top) / currentZoom;
        
        contextMenu.style.left = e.clientX + 'px';
        contextMenu.style.top = e.clientY + 'px';
        contextMenu.style.display = 'block';
    });
    
    // Hide context menu when clicking elsewhere
    document.addEventListener('click', function() {
        contextMenu.style.display = 'none';
    });
    
    // Handle context menu selections
    document.querySelectorAll('.context-menu-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.stopPropagation();
            
            const adType = this.dataset.adType;
            const inches = parseInt(this.dataset.inches);
            
            createSpecialEditionAd(clickX, clickY, adType, inches);
            contextMenu.style.display = 'none';
        });
    });
    
    // Handle marker clicks for deletion
    document.querySelectorAll('.ad-marker').forEach(marker => {
        marker.addEventListener('click', function(e) {
            e.stopPropagation();
            const boxId = this.dataset.boxId;
            
            deleteSpecialEditionAd(boxId);
        });
    });
}

function createSpecialEditionAd(x, y, adType, inches) {
    const data = {
        x: x - 15, // Offset for marker center
        y: y - 15,
        width: 30,  // Marker size
        height: 30,
        ad_type: adType,
        column_inches: inches
    };
    
    fetch(`/api/add_special_edition_ad/{{ page.id }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Create marker element
            const marker = document.createElement('div');
            marker.className = 'ad-marker';
            marker.dataset.boxId = data.box_id;
            marker.style.left = x + 'px';
            marker.style.top = y + 'px';
            marker.textContent = markerCounter++;
            marker.title = 'Click to delete';
            
            marker.addEventListener('click', function(e) {
                e.stopPropagation();
                deleteSpecialEditionAd(data.box_id);
            });
            
            document.getElementById('pageContainer').appendChild(marker);
            
            // Add to list
            addSpecialEditionAdToList(data, markerCounter - 1);
            
            // Update totals
            updatePageTotal();
        } else {
            alert('Error creating ad: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error creating ad:', error);
        alert('Error creating ad. Please try again.');
    });
}

function deleteSpecialEditionAd(boxId) {
    attemptDeleteSpecialEditionAd(boxId, 1);
}

function attemptDeleteSpecialEditionAd(boxId, attempt) {
    const maxAttempts = 2;
    
    fetch(`/api/delete_box/${boxId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove marker
            const marker = document.querySelector(`[data-box-id="${boxId}"]`);
            if (marker) {
                marker.remove();
            }
            
            // Remove list item
            const listItem = document.querySelector(`.ad-item[data-box-id="${boxId}"]`);
            if (listItem) {
                listItem.remove();
            }
            
            updatePageTotal();
        } else {
            if (data.error && data.error.includes('Database transaction error') && attempt < maxAttempts) {
                setTimeout(() => attemptDeleteSpecialEditionAd(boxId, attempt + 1), 1000);
            } else {
                let errorMsg = data.error || 'Unknown error occurred';
                if (errorMsg.includes('Database transaction error')) {
                    errorMsg += ' Please refresh the page if this persists.';
                }
                alert('Error deleting ad: ' + errorMsg);
            }
        }
    })
    .catch(error => {
        console.error('Error deleting ad:', error);
        if (attempt < maxAttempts) {
            setTimeout(() => attemptDeleteSpecialEditionAd(boxId, attempt + 1), 1000);
        } else {
            alert('Error deleting ad. Please check your connection and try again.');
        }
    });
}

function addSpecialEditionAdToList(adData, adNumber) {
    const listContainer = document.getElementById('adBoxesList');
    
    const adItem = document.createElement('div');
    adItem.className = 'ad-item';
    adItem.dataset.boxId = adData.box_id;
    
    let adTypeName = '';
    if (adData.column_inches === 14.04) adTypeName = '1/8 Page';
    if (adData.column_inches === 28.88) adTypeName = '1/4 Page';
    if (adData.column_inches === 59.28) adTypeName = '1/2 Page';
    if (adData.column_inches === 120.24) adTypeName = 'Full Page';
    
    adItem.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <div class="fw-bold text-primary">Ad #${adNumber}</div>
                <div class="text-success">${adData.column_inches}" inches</div>
                <div class="small text-muted">${adTypeName}</div>
            </div>
            <div class="text-end">
                <i class="fas fa-check-circle text-success" title="User verified"></i>
            </div>
        </div>
    `;
    
    listContainer.appendChild(adItem);
}

function updatePageTotal() {
    // Calculate new total from all ads
    let total = 0;
    document.querySelectorAll('.ad-item').forEach(item => {
        const inchesText = item.querySelector('.text-success').textContent;
        const value = parseInt(inchesText.replace('" inches', ''));
        if (!isNaN(value)) {
            total += value;
        }
    });
    
    const totalElement = document.getElementById('pageTotalInches');
    totalElement.textContent = total;
    
    // Add visual feedback
    totalElement.parentElement.classList.add('measurements-updated');
    setTimeout(() => {
        totalElement.parentElement.classList.remove('measurements-updated');
    }, 500);
}

// Broadsheet interface with intelligent click detection
function initializeBroadsheetInterface() {
    const pageContainer = document.getElementById('pageContainer');
    let contextMenu = null;
    
    // Left click for intelligent detection
    pageContainer.addEventListener('click', function(e) {
        // Don't detect if clicking on existing boxes, handles, or buttons
        if (e.target.closest('.ad-box') || 
            e.target.closest('.manual-box') || 
            e.target.closest('.measurement-box') ||
            e.target.classList.contains('resize-handle') ||
            e.target.classList.contains('delete-btn') ||
            e.target.classList.contains('delete-handle') ||
            e.target.classList.contains('ad-label')) {
            return; // Let the box handle its own interaction
        }
        
        const pageImage = document.getElementById('pageImage');
        const imageRect = pageImage.getBoundingClientRect();
        
        // Calculate coordinates relative to the actual image, not the container
        const x = Math.round((e.clientX - imageRect.left) / currentZoom);
        const y = Math.round((e.clientY - imageRect.top) / currentZoom);
        
        // Ensure coordinates are within image bounds
        const maxX = pageImage.naturalWidth || pageImage.width;
        const maxY = pageImage.naturalHeight || pageImage.height;
        
        if (x >= 0 && x < maxX && y >= 0 && y < maxY) {
            // Default to open display ad detection
            intelligentDetectAd(x, y, 'open_display');
        }
    });
    
    // Right click for manual box placement
    pageContainer.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        
        // Don't create manual box on existing boxes, handles, or buttons
        if (e.target.closest('.ad-box') || 
            e.target.closest('.manual-box') ||
            e.target.closest('.measurement-box') ||
            e.target.classList.contains('resize-handle') ||
            e.target.classList.contains('delete-btn') ||
            e.target.classList.contains('delete-handle') ||
            e.target.classList.contains('ad-label')) {
            return; // Let existing boxes handle their own interaction
        }
        
        const pageImage = document.getElementById('pageImage');
        const imageRect = pageImage.getBoundingClientRect();
        
        // Calculate coordinates relative to the actual image
        const x = Math.round((e.clientX - imageRect.left) / currentZoom);
        const y = Math.round((e.clientY - imageRect.top) / currentZoom);
        
        // Ensure coordinates are within image bounds
        const maxX = pageImage.naturalWidth || pageImage.width;
        const maxY = pageImage.naturalHeight || pageImage.height;
        
        if (x >= 0 && x < maxX && y >= 0 && y < maxY) {
            createManualBoxAtPosition(x, y);
        }
    });
    
    // Make existing ad boxes draggable
    document.querySelectorAll('.ad-box').forEach(box => {
        makeDraggable(box);
    });
}

function createManualBoxAtPosition(x, y) {
    console.log('Creating manual box at position:', x, y);

    // Save templates for any previously adjusted boxes
    savePendingTemplates();

    const pageContainer = document.getElementById('pageContainer');
    const pageImage = document.getElementById('pageImage');
    
    // Get image dimensions
    const imageWidth = pageImage.naturalWidth || pageImage.width;
    const imageHeight = pageImage.naturalHeight || pageImage.height;
    
    // Create a medium-sized box at the clicked position
    const boxWidth = Math.min(200, imageWidth * 0.2);
    const boxHeight = Math.min(150, imageHeight * 0.15);
    
    // Center the box on the click position, but keep it within bounds
    const boxX = Math.max(0, Math.min(x - boxWidth/2, imageWidth - boxWidth));
    const boxY = Math.max(0, Math.min(y - boxHeight/2, imageHeight - boxHeight));
    
    // Create manual box data
    const boxData = {
        x: boxX,
        y: boxY,
        width: boxWidth,
        height: boxHeight,
        ad_type: 'manual'
    };
    
    // Call API to create manual box
    console.log('Making API call to create manual box with data:', boxData);
    fetch(`/api/add_manual_box/{{ page.id }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(boxData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('🎯 Manual box created with ID:', data.box_id);
            console.log('🎯 Box coordinates:', {x: data.x, y: data.y, width: data.width, height: data.height});

            // Create visual manual box
            createManualBoxElement(data);

            // Update measurements panel
            addAdToSidebar(data);

            // Update page total
            updatePageTotalRegular();

            // Auto-save template
            console.log('🎯 Calling autoSaveTemplate for box_id:', data.box_id);
            autoSaveTemplate(data.box_id, data.x, data.y, data.width, data.height);

            // Show success message
            showSuccessMessage('Manual box created! Drag and resize to fit.');

        } else {
            showErrorMessage('Error creating manual box: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorMessage('Network error occurred');
    });
}

function intelligentDetectAd(x, y, adType) {
    // Show loading indicator
    showLoadingIndicator();
    
    fetch(`/api/intelligent_detect/{{ page.id }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            x: x,
            y: y,
            ad_type: adType
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoadingIndicator();
        
        if (data.success) {
            // Add detected ad box to the page
            addDetectedAdBox(data);
            updatePageTotalRegular();

            // Mark this box to have its template saved later
            pendingTemplateSaves.add(data.box_id);
            console.log('Left-click box added to pending templates:', data.box_id);

            // Show success message
            showSuccessMessage(`${adType.replace('_', ' ')} ad detected successfully!`);
        } else {
            showErrorMessage('Failed to detect ad: ' + data.error);
        }
    })
    .catch(error => {
        hideLoadingIndicator();
        console.error('Error:', error);
        showErrorMessage('Network error occurred');
    });
}

function addDetectedAdBox(data) {
    // Save any pending templates before adding new detected box
    console.log('About to save pending templates (left-click trigger)');
    savePendingTemplates();

    const pageContainer = document.getElementById('pageContainer');
    
    // Create ad box element
    const adBox = document.createElement('div');
    adBox.className = 'ad-box detected-ad';
    adBox.dataset.boxId = data.box_id;
    adBox.style.position = 'absolute';
    // Don't multiply by currentZoom - coordinates from server are already in image pixels
    adBox.style.left = data.x + 'px';
    adBox.style.top = data.y + 'px';
    adBox.style.width = data.width + 'px';
    adBox.style.height = data.height + 'px';
    adBox.style.border = '2px solid #28a745';
    adBox.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
    adBox.style.cursor = 'move';
    
    // Add label
    const label = document.createElement('div');
    label.className = 'ad-label';
    label.innerHTML = `${data.column_inches.toFixed(1)}" (${data.ad_type.replace('_', ' ')})`;
    adBox.appendChild(label);
    
    // Add delete button
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-btn';
    deleteBtn.innerHTML = '×';
    deleteBtn.style.position = 'absolute';
    deleteBtn.style.top = '-8px';
    deleteBtn.style.right = '-8px';
    deleteBtn.style.background = '#dc3545';
    deleteBtn.style.color = 'white';
    deleteBtn.style.border = 'none';
    deleteBtn.style.borderRadius = '50%';
    deleteBtn.style.width = '18px';
    deleteBtn.style.height = '18px';
    deleteBtn.style.fontSize = '12px';
    deleteBtn.style.cursor = 'pointer';
    deleteBtn.style.zIndex = '10';
    deleteBtn.style.display = 'flex';
    deleteBtn.style.alignItems = 'center';
    deleteBtn.style.justifyContent = 'center';
    deleteBtn.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        deleteAdBox(data.box_id);
    };
    adBox.appendChild(deleteBtn);
    
    pageContainer.appendChild(adBox);
    
    // Make it draggable
    makeDraggable(adBox);
    
    // Add to sidebar list
    addAdToSidebar(data);
    
    // Update last measured ad for copying
    updateLastMeasuredAd(data);
}


function showLoadingIndicator() {
    const indicator = document.createElement('div');
    indicator.id = 'loadingIndicator';
    indicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Detecting ad...';
    indicator.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 20px;
        border-radius: 5px;
        z-index: 2000;
    `;
    document.body.appendChild(indicator);
}

function hideLoadingIndicator() {
    const indicator = document.getElementById('loadingIndicator');
    if (indicator) {
        indicator.remove();
    }
}

function showSuccessMessage(message) {
    const msg = document.createElement('div');
    msg.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px;
        border-radius: 5px;
        z-index: 2000;
        color: white;
        background: #28a745;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    `;
    msg.textContent = message;
    document.body.appendChild(msg);
    
    setTimeout(() => {
        msg.remove();
    }, 3000);
}

function showErrorMessage(message) {
    const msg = document.createElement('div');
    msg.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px;
        border-radius: 5px;
        z-index: 2000;
        color: white;
        background: #dc3545;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    `;
    msg.textContent = message;
    document.body.appendChild(msg);
    
    setTimeout(() => {
        msg.remove();
    }, 3000);
}

function addAdToSidebar(data) {
    const adsList = document.getElementById('adBoxesList');
    if (!adsList) return;
    
    const adItem = document.createElement('div');
    adItem.className = 'ad-item';
    adItem.dataset.boxId = data.box_id;
    
    const adTypeName = data.ad_type.replace('_', ' ').toUpperCase();
    
    adItem.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <div class="fw-bold text-primary">${data.column_inches.toFixed(1)}" inches</div>
                <div class="small text-muted">
                    ${data.width_raw.toFixed(2)}" × ${data.height_raw.toFixed(2)}"
                </div>
                <div class="small text-success">
                    ${adTypeName}
                </div>
            </div>
            <div class="text-end">
                <i class="fas fa-check-circle text-success" title="Intelligently detected"></i>
            </div>
        </div>
    `;
    
    adsList.appendChild(adItem);
}

function makeDraggable(element) {
    let isDragging = false;
    let startX = 0;
    let startY = 0;
    let initialLeft = 0;
    let initialTop = 0;
    
    element.addEventListener('mousedown', function(e) {
        // Don't start dragging if clicking on delete button or other interactive elements
        if (e.target.classList.contains('delete-btn') || 
            e.target.classList.contains('delete-handle') ||
            e.target.closest('.delete-btn') ||
            e.target.closest('.delete-handle')) {
            return; // Let the delete button handle the click
        }
        
        e.preventDefault();
        isDragging = true;
        
        startX = e.clientX;
        startY = e.clientY;
        initialLeft = parseInt(element.style.left) || 0;
        initialTop = parseInt(element.style.top) || 0;
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    });
    
    function onMouseMove(e) {
        if (!isDragging) return;
        
        // Account for zoom when calculating movement
        const dx = (e.clientX - startX) / currentZoom;
        const dy = (e.clientY - startY) / currentZoom;
        
        // Get page bounds to constrain movement
        const pageImage = document.getElementById('pageImage');
        const maxX = (pageImage.naturalWidth || pageImage.width) - parseInt(element.style.width);
        const maxY = (pageImage.naturalHeight || pageImage.height) - parseInt(element.style.height);
        
        const newLeft = Math.max(0, Math.min(initialLeft + dx, maxX));
        const newTop = Math.max(0, Math.min(initialTop + dy, maxY));
        
        element.style.left = newLeft + 'px';
        element.style.top = newTop + 'px';
        
        // Auto-scroll functionality when dragging near viewport edges
        const elementWidth = parseInt(element.style.width);
        const elementHeight = parseInt(element.style.height);
        autoScrollDuringResize(newLeft, newTop, elementWidth, elementHeight, e.clientX, e.clientY);
    }
    
    function onMouseUp() {
        if (isDragging) {
            isDragging = false;
            
            // Update position in database
            const boxId = element.dataset.boxId;
            const x = parseInt(element.style.left);
            const y = parseInt(element.style.top);
            const width = parseInt(element.style.width);
            const height = parseInt(element.style.height);
            
            updateBoxInDatabase(boxId, { x, y, width, height });
        }
        
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
    }
}

function deleteAdBox(boxId) {
    // First attempt to delete
    attemptDeleteAdBox(boxId, 1);
}

function attemptDeleteAdBox(boxId, attempt) {
    const maxAttempts = 2;
    
    fetch(`/api/delete_box/${boxId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove visual element
            const boxElement = document.querySelector(`[data-box-id="${boxId}"]`);
            if (boxElement) {
                boxElement.remove();
            }
            
            // Remove from measurements list
            const listItem = document.querySelector(`.ad-item[data-box-id="${boxId}"]`);
            if (listItem) {
                listItem.remove();
            }
            
            updatePageTotalRegular();
            showSuccessMessage('Ad deleted successfully');
        } else {
            // Handle database transaction errors with retry
            if (data.error && data.error.includes('Database transaction error') && attempt < maxAttempts) {
                console.log(`Database transaction error on attempt ${attempt}, retrying...`);
                // Wait a moment then retry
                setTimeout(() => {
                    attemptDeleteAdBox(boxId, attempt + 1);
                }, 1000);
            } else {
                let errorMsg = data.error || 'Unknown error occurred';
                if (errorMsg.includes('Database transaction error')) {
                    errorMsg += ' Please refresh the page if this persists.';
                }
                showErrorMessage('Error deleting ad: ' + errorMsg);
            }
        }
    })
    .catch(error => {
        console.error('Error deleting ad:', error);
        if (attempt < maxAttempts) {
            console.log(`Network error on attempt ${attempt}, retrying...`);
            setTimeout(() => {
                attemptDeleteAdBox(boxId, attempt + 1);
            }, 1000);
        } else {
            showErrorMessage('Network error occurred. Please check your connection and try again.');
        }
    });
}

// Regular interface (for non-special editions) - button-triggered box creation
function initializeRegularInterface() {
    const addBoxBtn = document.getElementById('addBoxBtn');
    let isDrawingMode = false;
    let isCreatingBox = false;
    let creationStartX = 0;
    let creationStartY = 0;
    let tempBox = null;
    
    // Button click to enable drawing mode
    if (addBoxBtn) {
        addBoxBtn.addEventListener('click', function() {
            isDrawingMode = !isDrawingMode;
            const pageContainer = document.getElementById('pageContainer');
            
            if (isDrawingMode) {
                addBoxBtn.innerHTML = '<i class="fas fa-times"></i> Cancel Drawing';
                addBoxBtn.className = 'btn btn-danger';
                pageContainer.style.cursor = 'crosshair';
                
                // Add click handler for drawing
                pageContainer.addEventListener('mousedown', startBoxCreation);
            } else {
                addBoxBtn.innerHTML = '<i class="fas fa-plus"></i> Draw New Box';
                addBoxBtn.className = 'btn btn-success';
                pageContainer.style.cursor = '';
                
                // Remove click handler
                pageContainer.removeEventListener('mousedown', startBoxCreation);
            }
        });
    }
    
    function startBoxCreation(e) {
        if (!isDrawingMode) return;
        
        // Don't create box if clicking on existing elements
        if (e.target.classList.contains('measurement-box') || 
            e.target.classList.contains('resize-handle') || 
            e.target.classList.contains('delete-handle') ||
            e.target.closest('.measurement-box')) {
            return;
        }
        
        e.preventDefault();
        e.stopPropagation();
        
        isCreatingBox = true;
        const rect = e.currentTarget.getBoundingClientRect();
        // Adjust coordinates for zoom level
        creationStartX = (e.clientX - rect.left) / currentZoom;
        creationStartY = (e.clientY - rect.top) / currentZoom;
        
        // Create temporary visual box
        tempBox = document.createElement('div');
        tempBox.className = 'measurement-box temp-box';
        tempBox.style.left = creationStartX + 'px';
        tempBox.style.top = creationStartY + 'px';
        tempBox.style.width = '0px';
        tempBox.style.height = '0px';
        tempBox.style.borderStyle = 'dashed';
        tempBox.style.opacity = '0.7';
        e.currentTarget.appendChild(tempBox);
        
        document.addEventListener('mousemove', handleBoxCreation);
        document.addEventListener('mouseup', handleBoxCreationEnd);
    }
    
    function handleBoxCreation(e) {
        if (!isCreatingBox || !tempBox) return;
        
        const rect = document.getElementById('pageContainer').getBoundingClientRect();
        // Adjust coordinates for zoom level
        const currentX = (e.clientX - rect.left) / currentZoom;
        const currentY = (e.clientY - rect.top) / currentZoom;
        
        const width = Math.abs(currentX - creationStartX);
        const height = Math.abs(currentY - creationStartY);
        const left = Math.min(currentX, creationStartX);
        const top = Math.min(currentY, creationStartY);
        
        tempBox.style.left = left + 'px';
        tempBox.style.top = top + 'px';
        tempBox.style.width = width + 'px';
        tempBox.style.height = height + 'px';
        
        // Auto-scroll functionality when creating box near viewport edges
        autoScrollDuringResize(left, top, width, height, e.clientX, e.clientY);
    }
    
    function handleBoxCreationEnd(e) {
        if (!isCreatingBox || !tempBox) return;
        
        isCreatingBox = false;
        
        const width = parseInt(tempBox.style.width);
        const height = parseInt(tempBox.style.height);
        const left = parseInt(tempBox.style.left);
        const top = parseInt(tempBox.style.top);
        
        // Remove temp box
        tempBox.remove();
        tempBox = null;
        
        // Only create box if it has reasonable size (at least 10x10 pixels)
        if (width >= 10 && height >= 10) {
            createNewBox(left, top, width, height);
        }
        
        // Exit drawing mode
        isDrawingMode = false;
        addBoxBtn.innerHTML = '<i class="fas fa-plus"></i> Draw New Box';
        addBoxBtn.className = 'btn btn-success';
        document.getElementById('pageContainer').style.cursor = '';
        document.getElementById('pageContainer').removeEventListener('mousedown', startBoxCreation);
        
        document.removeEventListener('mousemove', handleBoxCreation);
        document.removeEventListener('mouseup', handleBoxCreationEnd);
    }
    
    // Initialize existing boxes
    initializeExistingBoxes();
}

function createNewBox(x, y, width, height) {
    // Create the box data
    const boxData = {
        x: Math.max(0, x),
        y: Math.max(0, y),
        width: width,
        height: height
    };
    
    // Send to server to create in database
    fetch(`/api/add_box/{{ page.id }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(boxData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Create the visual box element
            const boxElement = createBoxElement(data.box_id, boxData.x, boxData.y, boxData.width, boxData.height);
            document.getElementById('pageContainer').appendChild(boxElement);

            // Add to measurements list
            addBoxToMeasurementsList(data);

            // Update page total
            updatePageTotalRegular();

            // Make it immediately interactive
            initializeBoxInteraction(boxElement);

            // Check for template learning opportunity
            checkForTemplatePrompt(data);
        } else {
            alert('Error creating box: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error creating box:', error);
        alert('Error creating box. Please try again.');
    });
}

function checkForTemplatePrompt(response) {
    if (response.success) {
        // Wait a moment for the ad box to be drawn
        setTimeout(() => {
            const businessName = prompt("Save this ad as a template for automatic detection?\n\nEnter business name (or Cancel to skip):");

            if (businessName && businessName.trim()) {
                saveAdTemplate(response.box_id, businessName.trim());
            }
        }, 500);
    }
}

function saveAdTemplate(boxId, businessName = null) {
    fetch(`/api/save_template/${boxId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            business_name: businessName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.needs_business_name) {
            // Show business name selection dialog
            promptBusinessName(boxId, data.suggested_names);
        } else if (data.success) {
            showSuccessMessage(data.message);
        } else {
            showErrorMessage('Template save failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Template save error:', error);
        showErrorMessage('Error saving template');
    });
}

function promptBusinessName(boxId, suggestedNames) {
    console.log('🔔 promptBusinessName called:', {boxId, suggestedNames});

    // CRITICAL: Clear any previous dialog WITHOUT resolving the promise
    const oldDialog = document.getElementById('businessNameDialog');
    const oldBackdrop = document.getElementById('businessNameBackdrop');
    if (oldDialog) {
        console.log('⚠️ Removing old dialog element (without resolving promise)');
        oldDialog.remove();
    }
    if (oldBackdrop) {
        oldBackdrop.remove();
    }

    // Store current box ID for submission
    window.currentBoxId = boxId;

    const dialog = document.createElement('div');
    dialog.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        z-index: 10000;
        min-width: 400px;
    `;

    let html = `
        <h3>Select Business Name for Template</h3>
        <p style="font-size: 12px; color: #666;">Box ID: ${boxId}</p>
        <div id="modalContent">
    `;

    if (suggestedNames && suggestedNames.length > 0) {
        html += '<p>Detected text from ad:</p>';
        html += '<div style="margin: 10px 0;">';
        suggestedNames.forEach((name, idx) => {
            html += `
                <label style="display: block; padding: 8px; cursor: pointer; border: 1px solid #ddd; margin: 5px 0; border-radius: 4px;">
                    <input type="radio" name="businessName" value="${name}" ${idx === 0 ? 'checked' : ''}>
                    ${name}
                </label>
            `;
        });
        html += '</div>';
    } else {
        html += '<p style="color: #666; font-style: italic;">Enter business name below (OCR suggestions loading...)</p>';
    }

    html += `
            <p>Or enter custom name:</p>
            <input type="text" id="customBusinessName" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 10px 0;">
            <div style="margin-top: 15px; text-align: right;">
                <button onclick="cancelBusinessNamePrompt()" style="padding: 8px 16px; margin-right: 10px; background: #ccc; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                <button onclick="confirmBusinessName()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Save Template</button>
            </div>
        </div>
    `;

    dialog.innerHTML = html;
    dialog.id = 'businessNameDialog';

    console.log('📋 Appending dialog to document.body');
    document.body.appendChild(dialog);
    console.log('✅ Dialog appended - should be visible NOW');

    // Add backdrop
    const backdrop = document.createElement('div');
    backdrop.id = 'businessNameBackdrop';
    backdrop.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
    `;
    document.body.appendChild(backdrop);
}

function confirmBusinessName() {
    const customName = document.getElementById('customBusinessName').value.trim();
    const selectedRadio = document.querySelector('input[name="businessName"]:checked');

    const businessName = customName || (selectedRadio ? selectedRadio.value : null);

    if (!businessName) {
        alert('Please select or enter a business name');
        return;
    }

    const boxId = window.currentBoxId;
    if (!boxId) {
        alert('Error: Box ID not found');
        return;
    }

    console.log('✅✅✅ User confirmed business name:', businessName, 'for Box:', boxId);

    // Close modal MANUALLY (don't use cancelBusinessNamePrompt - it resolves the promise)
    const dialog = document.getElementById('businessNameDialog');
    const backdrop = document.getElementById('businessNameBackdrop');
    if (dialog) {
        console.log('   Removing dialog');
        dialog.remove();
    }
    if (backdrop) {
        console.log('   Removing backdrop');
        backdrop.remove();
    }

    // Save with business name
    console.log('   Calling saveAdTemplate for Box:', boxId, 'with name:', businessName);
    saveAdTemplate(boxId, businessName);

    // Resolve the promise to continue queue processing
    console.log('   Resolving promise to continue queue');
    if (window.resolveBusinessNameModal) {
        window.resolveBusinessNameModal();
        window.resolveBusinessNameModal = null;
    }
}

function cancelBusinessNamePrompt() {
    console.log('🚫🚫🚫 cancelBusinessNamePrompt CALLED');
    console.trace('Call stack:');  // This will show WHERE it was called from

    const dialog = document.getElementById('businessNameDialog');
    const backdrop = document.getElementById('businessNameBackdrop');

    console.log('   Dialog exists:', !!dialog);
    console.log('   Backdrop exists:', !!backdrop);
    console.log('   Current Box ID:', window.currentBoxId);
    console.log('   Resolve function exists:', !!window.resolveBusinessNameModal);

    if (dialog) dialog.remove();
    if (backdrop) backdrop.remove();

    // Resolve the promise to continue queue processing (even if cancelled)
    if (window.resolveBusinessNameModal) {
        console.log('⚠️ User cancelled business name modal - RESOLVING PROMISE');
        window.resolveBusinessNameModal();
        window.resolveBusinessNameModal = null;
    }
}

// Template save queue to prevent race conditions
let templateSaveQueue = [];
let currentlySaving = false;

async function autoSaveTemplate(boxId, x, y, width, height) {
    const timestamp = new Date().toISOString();
    console.log('');
    console.log('═══════════════════════════════════════════════════════════');
    console.log(`🎯 [${timestamp}] ADDING TO QUEUE`);
    console.log(`   Box ID: ${boxId}`);
    console.log(`   Coordinates: (${x}, ${y}) - ${width}x${height}`);
    console.log(`   Currently saving: ${currentlySaving}`);
    console.log(`   Queue length before: ${templateSaveQueue.length}`);
    console.log('═══════════════════════════════════════════════════════════');
    console.log('');

    // Add to queue
    templateSaveQueue.push({boxId, x, y, width, height});

    console.log(`   Queue length after: ${templateSaveQueue.length}`);
    console.log(`   Queue contents: ${JSON.stringify(templateSaveQueue.map(item => item.boxId))}`);

    // Process queue if not already processing
    if (!currentlySaving) {
        console.log(`   ✅ Starting queue processing NOW for Box ${boxId}`);
        processTemplateSaveQueue();
    } else {
        console.log(`   ⏸️ Queue is already processing, Box ${boxId} will be processed later`);
    }
}

async function processTemplateSaveQueue() {
    if (templateSaveQueue.length === 0) {
        currentlySaving = false;
        console.log('');
        console.log('✅✅✅ QUEUE EMPTY - All templates processed ✅✅✅');
        console.log('');
        return;
    }

    currentlySaving = true;
    const {boxId, x, y, width, height} = templateSaveQueue.shift();

    const timestamp = new Date().toISOString();
    console.log('');
    console.log('▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓');
    console.log(`📋 [${timestamp}] PROCESSING FROM QUEUE`);
    console.log(`   Box ID: ${boxId}`);
    console.log(`   Remaining in queue: ${templateSaveQueue.length}`);
    console.log(`   Queue contents: ${JSON.stringify(templateSaveQueue.map(item => item.boxId))}`);
    console.log('▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓');
    console.log('');

    // SHOW MODAL IMMEDIATELY - no loading, no waiting for API
    console.log(`🔔 [${timestamp}] SHOWING MODAL IMMEDIATELY FOR BOX: ${boxId}`);
    const modalPromise = showBusinessNameModalAsync(boxId, []); // Empty array = show input field right away

    try {
        console.log(`📤 [${new Date().toISOString()}] SENDING API REQUEST for Box: ${boxId} (in background)`);
        const response = await fetch(`/api/save_template/${boxId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({x, y, width, height, auto_saved: true})
        });

        const receiveTimestamp = new Date().toISOString();
        console.log(`📥 [${receiveTimestamp}] RECEIVED API RESPONSE for Box: ${boxId}`);
        const data = await response.json();
        console.log(`   Response for Box ${boxId}:`, data);
        console.log(`   Suggested names for Box ${boxId}:`, data.suggested_names);

        if (data.needs_business_name && data.suggested_names && data.suggested_names.length > 0) {
            console.log('');
            console.log('🎨 OCR SUGGESTIONS RECEIVED - Updating modal with suggestions');
            console.log(`🎨 Suggestions: ${JSON.stringify(data.suggested_names)}`);
            console.log('');
            // Update the modal with OCR suggestions if available
            populateBusinessNameModal(boxId, data.suggested_names);
        }

        // Wait for user input before processing next
        console.log(`⏸️ WAITING for user to complete modal for Box ${boxId}...`);
        await modalPromise;
        console.log(`✅ User completed modal for Box ${boxId}`);

    } catch (error) {
        console.error(`❌❌❌ FETCH ERROR for Box ${boxId}:`, error);
        console.error('Error stack:', error.stack);
        // Even on error, wait for user to close modal
        await modalPromise;
    }

    // Process next item in queue
    console.log('');
    console.log(`➡️ Moving to next item in queue...`);
    console.log('');
    processTemplateSaveQueue();
}

function showBusinessNameModalAsync(boxId, suggestedNames) {
    return new Promise((resolve) => {
        console.log('🔔 showBusinessNameModalAsync called:', {boxId, suggestedNames});

        // Store resolve function to call when user submits
        window.resolveBusinessNameModal = resolve;

        // Always show modal with input field immediately
        // If we have suggestions, show them; if not, just show empty input
        promptBusinessName(boxId, suggestedNames || []);
    });
}

function promptBusinessNameLoading(boxId) {
    console.log('🔔 promptBusinessNameLoading called for box:', boxId);
    console.log('🔔 This modal will show data for BOX ID:', boxId);

    // CRITICAL: Clear any previous dialog WITHOUT resolving the promise
    const oldDialog = document.getElementById('businessNameDialog');
    const oldBackdrop = document.getElementById('businessNameBackdrop');
    if (oldDialog) {
        console.log('⚠️ Removing old dialog element (without resolving promise)');
        oldDialog.remove();
    }
    if (oldBackdrop) {
        oldBackdrop.remove();
    }

    // Store current box ID for submission
    window.currentBoxId = boxId;
    console.log('🔔 Stored window.currentBoxId =', window.currentBoxId);

    const dialog = document.createElement('div');
    dialog.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        z-index: 10000;
        min-width: 400px;
    `;

    dialog.innerHTML = `
        <h3>Select Business Name for Template</h3>
        <p style="font-size: 12px; color: #666;">Box ID: ${boxId}</p>
        <div id="modalContent" style="padding: 20px; text-align: center;">
            <p>Loading ad text for Box ${boxId}...</p>
            <div style="margin: 20px 0;">⏳</div>
        </div>
    `;

    dialog.id = 'businessNameDialog';
    document.body.appendChild(dialog);

    // Add backdrop
    const backdrop = document.createElement('div');
    backdrop.id = 'businessNameBackdrop';
    backdrop.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
    `;
    document.body.appendChild(backdrop);
}

function populateBusinessNameModal(boxId, suggestedNames) {
    console.log('📝 populateBusinessNameModal called for BOX ID:', boxId);
    console.log('📝 Suggested names:', suggestedNames);

    const modalContent = document.getElementById('modalContent');
    if (!modalContent) {
        console.error('❌ Modal content element not found!');
        return;
    }

    // Update box ID
    window.currentBoxId = boxId;
    console.log('📝 Updated window.currentBoxId to:', boxId);

    let html = `<p><strong>Box ID: ${boxId}</strong></p>`;
    html += '<p>Detected text from ad:</p>';

    if (suggestedNames && suggestedNames.length > 0) {
        html += '<div style="margin: 10px 0;">';
        suggestedNames.forEach((name, idx) => {
            html += `
                <label style="display: block; padding: 8px; cursor: pointer; border: 1px solid #ddd; margin: 5px 0; border-radius: 4px;">
                    <input type="radio" name="businessName" value="${name}" ${idx === 0 ? 'checked' : ''}>
                    ${name}
                </label>
            `;
        });
        html += '</div>';
    } else {
        html += '<p style="color: #999;">No text detected</p>';
    }

    html += `
        <p>Or enter custom name:</p>
        <input type="text" id="customBusinessName" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 10px 0;">
        <div style="margin-top: 15px; text-align: right;">
            <button onclick="cancelBusinessNamePrompt()" style="padding: 8px 16px; margin-right: 10px; background: #ccc; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
            <button onclick="confirmBusinessName()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Save Template</button>
        </div>
    `;

    modalContent.innerHTML = html;
}

function savePendingTemplates() {
    console.log('=== savePendingTemplates CALLED ===');
    console.log('Pending count:', pendingTemplateSaves.size);
    console.log('Pending IDs:', Array.from(pendingTemplateSaves));

    if (pendingTemplateSaves.size === 0) {
        console.log('No pending templates, returning early');
        return;
    }

    // Get all boxes that need templates saved
    const boxesToSave = Array.from(pendingTemplateSaves);
    pendingTemplateSaves.clear();

    // Save template for each box
    boxesToSave.forEach(boxId => {
        const boxElement = document.querySelector(`[data-box-id="${boxId}"]`);
        if (boxElement) {
            const x = parseInt(boxElement.style.left);
            const y = parseInt(boxElement.style.top);
            const width = parseInt(boxElement.style.width);
            const height = parseInt(boxElement.style.height);

            autoSaveTemplate(boxId, x, y, width, height);
        }
    });
}

function createBoxElement(boxId, x, y, width, height) {
    const box = document.createElement('div');
    box.className = 'measurement-box';
    box.dataset.boxId = boxId;
    box.style.left = x + 'px';
    box.style.top = y + 'px';
    box.style.width = width + 'px';
    box.style.height = height + 'px';
    
    // Add resize handles
    const handles = ['nw', 'ne', 'sw', 'se', 'n', 's', 'w', 'e'];
    handles.forEach(handle => {
        const handleElement = document.createElement('div');
        handleElement.className = `resize-handle ${handle}`;
        box.appendChild(handleElement);
    });
    
    // Add delete button
    const deleteHandle = document.createElement('div');
    deleteHandle.className = 'delete-handle';
    deleteHandle.innerHTML = '×';
    deleteHandle.title = 'Delete this box';
    box.appendChild(deleteHandle);
    
    return box;
}

function initializeExistingBoxes() {
    document.querySelectorAll('.measurement-box').forEach(box => {
        initializeBoxInteraction(box);
    });
}

function initializeBoxInteraction(box) {
    const boxId = box.dataset.boxId;
    let startX, startY, startWidth, startHeight, startMouseX, startMouseY;
    let localIsDragging = false;
    let localIsResizing = false;
    let localSelectedBox = null;
    let localResizeHandle = null;
    let localDragOffset = { x: 0, y: 0 };
    
    // Delete functionality
    const deleteHandle = box.querySelector('.delete-handle');
    if (deleteHandle) {
        deleteHandle.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            deleteBox(boxId);
        });
    }
    
    // Box moving - only on the box itself, not handles
    box.addEventListener('mousedown', function(e) {
        // Don't move if clicking on handles
        if (e.target.classList.contains('resize-handle') || 
            e.target.classList.contains('delete-handle')) {
            return;
        }
        
        e.preventDefault();
        e.stopPropagation();
        
        localIsDragging = true;
        localSelectedBox = box;
        box.classList.add('selected');
        
        const rect = box.getBoundingClientRect();
        const containerRect = document.getElementById('pageContainer').getBoundingClientRect();
        
        // Adjust drag offset for zoom level
        localDragOffset.x = (e.clientX - rect.left) / currentZoom;
        localDragOffset.y = (e.clientY - rect.top) / currentZoom;
        
        const handleDrag = function(e) {
            if (!localIsDragging || !localSelectedBox) return;
            
            const containerRect = document.getElementById('pageContainer').getBoundingClientRect();
            // Adjust coordinates for zoom level
            const newX = (e.clientX - containerRect.left) / currentZoom - localDragOffset.x;
            const newY = (e.clientY - containerRect.top) / currentZoom - localDragOffset.y;
            
            // Get container bounds at current zoom
            const pageImage = document.getElementById('pageImage');
            const maxX = (pageImage.naturalWidth || pageImage.width) - localSelectedBox.offsetWidth;
            const maxY = (pageImage.naturalHeight || pageImage.height) - localSelectedBox.offsetHeight;
            
            const constrainedX = Math.max(0, Math.min(newX, maxX));
            const constrainedY = Math.max(0, Math.min(newY, maxY));
            
            localSelectedBox.style.left = constrainedX + 'px';
            localSelectedBox.style.top = constrainedY + 'px';
            
            // Auto-scroll functionality when dragging near viewport edges
            autoScrollDuringResize(constrainedX, constrainedY, localSelectedBox.offsetWidth, localSelectedBox.offsetHeight, e.clientX, e.clientY);
        };
        
        const handleDragEnd = function(e) {
            if (!localIsDragging || !localSelectedBox) return;
            
            localIsDragging = false;
            
            // Update box in database
            const boxData = {
                x: parseInt(localSelectedBox.style.left),
                y: parseInt(localSelectedBox.style.top),
                width: parseInt(localSelectedBox.style.width),
                height: parseInt(localSelectedBox.style.height)
            };
            
            updateBoxInDatabase(localSelectedBox.dataset.boxId, boxData);
            
            localSelectedBox.classList.remove('selected');
            localSelectedBox = null;
            
            document.removeEventListener('mousemove', handleDrag);
            document.removeEventListener('mouseup', handleDragEnd);
        };
        
        document.addEventListener('mousemove', handleDrag);
        document.addEventListener('mouseup', handleDragEnd);
    });
    
    // Resize functionality
    box.querySelectorAll('.resize-handle').forEach(handle => {
        handle.addEventListener('mousedown', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            localIsResizing = true;
            localSelectedBox = box;
            localResizeHandle = handle;
            box.classList.add('selected');
            
            const rect = box.getBoundingClientRect();
            const containerRect = document.getElementById('pageContainer').getBoundingClientRect();
            
            startX = rect.left - containerRect.left;
            startY = rect.top - containerRect.top;
            startWidth = rect.width;
            startHeight = rect.height;
            startMouseX = e.clientX;
            startMouseY = e.clientY;
            
            const handleResize = function(e) {
                if (!localIsResizing || !localSelectedBox || !localResizeHandle) return;
                
                const deltaX = e.clientX - startMouseX;
                const deltaY = e.clientY - startMouseY;
                
                let newX = startX;
                let newY = startY;
                let newWidth = startWidth;
                let newHeight = startHeight;
                
                const handleClass = localResizeHandle.className.split(' ')[1];
                
                switch (handleClass) {
                    case 'nw':
                        newX = startX + deltaX;
                        newY = startY + deltaY;
                        newWidth = startWidth - deltaX;
                        newHeight = startHeight - deltaY;
                        break;
                    case 'ne':
                        newY = startY + deltaY;
                        newWidth = startWidth + deltaX;
                        newHeight = startHeight - deltaY;
                        break;
                    case 'sw':
                        newX = startX + deltaX;
                        newWidth = startWidth - deltaX;
                        newHeight = startHeight + deltaY;
                        break;
                    case 'se':
                        newWidth = startWidth + deltaX;
                        newHeight = startHeight + deltaY;
                        break;
                    case 'n':
                        newY = startY + deltaY;
                        newHeight = startHeight - deltaY;
                        break;
                    case 's':
                        newHeight = startHeight + deltaY;
                        break;
                    case 'w':
                        newX = startX + deltaX;
                        newWidth = startWidth - deltaX;
                        break;
                    case 'e':
                        newWidth = startWidth + deltaX;
                        break;
                }
                
                // Enforce minimum size
                if (newWidth < 20) {
                    newWidth = 20;
                    if (handleClass.includes('w')) {
                        newX = startX + startWidth - 20;
                    }
                }
                if (newHeight < 20) {
                    newHeight = 20;
                    if (handleClass.includes('n')) {
                        newY = startY + startHeight - 20;
                    }
                }
                
                // Keep within container bounds
                const containerRect = document.getElementById('pageContainer').getBoundingClientRect();
                newX = Math.max(0, Math.min(newX, containerRect.width - newWidth));
                newY = Math.max(0, Math.min(newY, containerRect.height - newHeight));
                
                localSelectedBox.style.left = newX + 'px';
                localSelectedBox.style.top = newY + 'px';
                localSelectedBox.style.width = newWidth + 'px';
                localSelectedBox.style.height = newHeight + 'px';
                
                // Auto-scroll functionality when resizing near viewport edges
                autoScrollDuringResize(newX, newY, newWidth, newHeight, e.clientX, e.clientY);
            };
            
            const handleResizeEnd = function(e) {
                if (!localIsResizing || !localSelectedBox) return;
                
                localIsResizing = false;
                
                // Update box in database
                const boxData = {
                    x: parseInt(localSelectedBox.style.left),
                    y: parseInt(localSelectedBox.style.top),
                    width: parseInt(localSelectedBox.style.width),
                    height: parseInt(localSelectedBox.style.height)
                };
                
                updateBoxInDatabase(localSelectedBox.dataset.boxId, boxData);
                
                localSelectedBox.classList.remove('selected');
                localSelectedBox = null;
                localResizeHandle = null;
                
                document.removeEventListener('mousemove', handleResize);
                document.removeEventListener('mouseup', handleResizeEnd);
            };
            
            document.addEventListener('mousemove', handleResize);
            document.addEventListener('mouseup', handleResizeEnd);
        });
    });
}

function updateBoxInDatabase(boxId, boxData) {
    // Check if this is a manual box by looking at the element
    const boxElement = document.querySelector(`[data-box-id="${boxId}"]`);
    const isManualBox = boxElement && boxElement.classList.contains('manual-box');
    
    // Use appropriate API endpoint
    const endpoint = isManualBox ? `/api/update_manual_box/${boxId}` : `/api/update_box/${boxId}`;
    
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(boxData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update measurements in the list
            if (isManualBox) {
                updateManualBoxInSidebar(boxId, data);
                // Update last measured ad for copying when manual box is resized/moved
                updateLastMeasuredAd(data);
            } else {
                updateBoxInMeasurementsList(boxId, data);
            }
            updatePageTotalRegular();
            
            // Update the label on the box
            if (isManualBox && boxElement) {
                const label = boxElement.querySelector('.ad-label');
                if (label) {
                    label.innerHTML = `${data.column_inches.toFixed(1)}" (manual)`;
                }
            }
        } else {
            console.error('Error updating box:', data.error);
        }
    })
    .catch(error => {
        console.error('Error updating box:', error);
    });
}

function deleteBox(boxId) {
    fetch(`/api/delete_box/${boxId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove visual element
            const boxElement = document.querySelector(`[data-box-id="${boxId}"]`);
            if (boxElement) {
                boxElement.remove();
            }
            
            // Remove from measurements list
            const listItem = document.querySelector(`.ad-item[data-box-id="${boxId}"]`);
            if (listItem) {
                listItem.remove();
            }
            
            updatePageTotalRegular();
        } else {
            alert('Error deleting box: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error deleting box:', error);
        alert('Error deleting box. Please try again.');
    });
}

function addBoxToMeasurementsList(boxData) {
    const listContainer = document.getElementById('adBoxesList');
    
    const adItem = document.createElement('div');
    adItem.className = 'ad-item';
    adItem.dataset.boxId = boxData.box_id;
    
    adItem.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <div class="fw-bold text-primary">${boxData.column_inches.toFixed(1)}" inches</div>
                <div class="small text-muted">
                    ${boxData.width_raw.toFixed(2)}" × ${boxData.height_raw.toFixed(2)}"
                </div>
            </div>
            <div class="text-end">
                <i class="fas fa-check-circle text-success" title="User verified"></i>
            </div>
        </div>
    `;
    
    listContainer.appendChild(adItem);
}

function updateBoxInMeasurementsList(boxId, boxData) {
    const listItem = document.querySelector(`.ad-item[data-box-id="${boxId}"]`);
    if (listItem) {
        listItem.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="fw-bold text-primary">${boxData.column_inches.toFixed(1)}" inches</div>
                    <div class="small text-muted">
                        ${boxData.width_raw.toFixed(2)}" × ${boxData.height_raw.toFixed(2)}"
                    </div>
                </div>
                <div class="text-end">
                    <i class="fas fa-check-circle text-success" title="User verified"></i>
                </div>
            </div>
        `;
        
        // Add visual feedback
        listItem.classList.add('measurements-updated');
        setTimeout(() => {
            listItem.classList.remove('measurements-updated');
        }, 500);
    }
}

function updatePageTotalRegular() {
    // Calculate new total from all ads
    let total = 0;
    document.querySelectorAll('.ad-item').forEach(item => {
        const inchesText = item.querySelector('.fw-bold').textContent;
        const value = parseFloat(inchesText.replace('" inches', ''));
        if (!isNaN(value)) {
            total += value;
        }
    });
    
    const totalElement = document.getElementById('pageTotalInches');
    totalElement.textContent = Math.round(total);
    
    // Add visual feedback
    totalElement.parentElement.classList.add('measurements-updated');
    setTimeout(() => {
        totalElement.parentElement.classList.remove('measurements-updated');
    }, 500);
}

// Prevent default drag behavior on images
document.getElementById('pageImage').addEventListener('dragstart', function(e) {
    e.preventDefault();
});
</script>
{% endblock %}